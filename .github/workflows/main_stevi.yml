# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy Node.js app to Azure Web App - STEVI

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      slot:
        description: "Target App Service slot (Production or staging)"
        required: false
        default: "Production"

concurrency:
  group: stevi-${{ github.ref_name }}
  cancel-in-progress: true

env:
  APP_NAME: STEVI
  NODE_VERSION: "24.11.1"
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL || secrets.NEXT_PUBLIC_SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
  NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
  NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
  PORTAL_ALERTS_SECRET: ${{ secrets.PORTAL_ALERTS_SECRET }}
  NEXT_PUBLIC_ANALYTICS_DISABLED: ${{ secrets.NEXT_PUBLIC_ANALYTICS_DISABLED }}
  NEXT_PUBLIC_GA4_ID: ${{ secrets.NEXT_PUBLIC_GA4_ID }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js version
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Next.js build cache
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ env.NODE_VERSION }}-

      - name: Type check
        run: npm run typecheck

      - name: Build
        run: npm run build

      - name: Test (if configured)
        run: npm run test --if-present

      - name: Validate build artifacts
        run: |
          if [ ! -f ".next/standalone/server.js" ]; then
            echo ".next/standalone/server.js is missing after build" >&2
            ls -la .next
            exit 1
          fi
          if [ ! -d ".next/static" ]; then
            echo ".next/static is missing after build" >&2
            exit 1
          fi
          if [ ! -d ".next/standalone/.next/static" ]; then
            echo ".next/standalone/.next/static is missing after build (static assets must live next to the standalone server)" >&2
            exit 1
          fi
          if ! ls .next/standalone/.next/static/css/*.css >/dev/null 2>&1; then
            echo "No CSS assets found under .next/standalone/.next/static/css" >&2
            exit 1
          fi
          if ! node -e "const m=require('./.next/server/middleware-manifest.json'); if (!m.sortedMiddleware || m.sortedMiddleware.length === 0) process.exit(1);"; then
            echo "Middleware build validation failed: .next/server/middleware-manifest.json has no entries" >&2
            cat .next/server/middleware-manifest.json || true
            exit 1
          fi

      - name: Prune dev dependencies for deployment
        run: npm prune --omit=dev

      - name: Create deployment bundle
        run: |
          set -euo pipefail
          mkdir -p deployment/.next deployment/public

          cp -r .next/standalone deployment/.next/standalone
          cp -r public/. deployment/public/ || true
          cp package.json deployment/

          if [ ! -f "deployment/.next/standalone/server.js" ]; then
            echo "Deployment bundle validation failed: .next/standalone/server.js missing" >&2
            exit 1
          fi
          if [ ! -d "deployment/.next/standalone/.next/static" ]; then
            echo "Deployment bundle validation failed: .next/standalone/.next/static missing" >&2
            exit 1
          fi
          if ! node -e "const m=require('./deployment/.next/standalone/.next/server/middleware-manifest.json'); if (!m.sortedMiddleware || m.sortedMiddleware.length === 0) process.exit(1);"; then
            echo "Deployment bundle validation failed: middleware manifest is empty" >&2
            cat deployment/.next/standalone/.next/server/middleware-manifest.json || true
            exit 1
          fi

      - name: Archive deployment bundle
        run: |
          cd deployment
          zip -r ../node-app.zip .

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: node-app.zip
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.slot) || 'production' }}
    permissions:
      contents: read
      actions: write
    
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app
          path: .

      - name: Validate deployment bundle contents
        shell: bash
        run: |
          if ! unzip -l node-app.zip | grep -q ".next/standalone/server.js"; then
            echo "Expected .next/standalone/server.js in deployment bundle" >&2
            unzip -l node-app.zip || true
            exit 1
          fi
          if ! unzip -l node-app.zip | grep -q ".next/standalone/.next/static/css"; then
            echo "Expected .next/standalone/.next/static assets in deployment bundle" >&2
            unzip -l node-app.zip || true
            exit 1
          fi

      - name: Resolve target slot and publish profile
        id: slot
        shell: bash
        run: |
          slot_input="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.slot || '' }}"
          if [ -z "$slot_input" ]; then
            slot_input="Production"
          fi
          slot_normalized="$(echo "$slot_input" | tr '[:upper:]' '[:lower:]')"
          if [ "$slot_normalized" != "production" ] && [ "$slot_normalized" != "staging" ]; then
            echo "Slot must be Production or staging; received '$slot_input'." >&2
            exit 1
          fi

          if [ "$slot_normalized" = "staging" ]; then
            if [ -z "${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_STAGING }}" ]; then
              echo "Staging slot requested but AZUREAPPSERVICE_PUBLISHPROFILE_STAGING is not configured." >&2
              exit 1
            fi
            echo "slot=staging" >> "$GITHUB_OUTPUT"
          else
            echo "slot=Production" >> "$GITHUB_OUTPUT"
          fi

      - name: Archive package
        run: |
          echo "node-app.zip is already packaged from the build job"

      - name: 'Deploy to Azure Web App'
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_NAME }}
          slot-name: ${{ steps.slot.outputs.slot }}
          package: node-app.zip
          publish-profile: ${{ steps.slot.outputs.slot == 'staging' && secrets.AZUREAPPSERVICE_PUBLISHPROFILE_STAGING || secrets.AZUREAPPSERVICE_PUBLISHPROFILE_C1805A0956574B47AE4629B59BCC2619 }}

      - name: Delete deployment artifact (node-app)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const run_id = context.runId;
            const artifacts = await github.paginate(github.rest.actions.listWorkflowRunArtifacts, {
              owner,
              repo,
              run_id,
            });

            const matches = artifacts.filter((artifact) => artifact.name === 'node-app');
            if (matches.length === 0) {
              core.info('No node-app artifact found for this run.');
              return;
            }

            for (const artifact of matches) {
              core.info(`Deleting artifact ${artifact.id} (${artifact.size_in_bytes} bytes).`);
              await github.rest.actions.deleteArtifact({ owner, repo, artifact_id: artifact.id });
            }
