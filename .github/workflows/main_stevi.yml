# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy Node.js app to Azure Web App - STEVI

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      slot:
        description: "Target App Service slot (Production or staging)"
        required: false
        default: "Production"

concurrency:
  group: stevi-${{ github.ref_name }}
  cancel-in-progress: true

env:
  APP_NAME: STEVI
  NODE_VERSION: "24.x"
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL || secrets.NEXT_PUBLIC_SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
  NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
  NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
  PORTAL_ALERTS_SECRET: ${{ secrets.PORTAL_ALERTS_SECRET }}
  NEXT_PUBLIC_ANALYTICS_DISABLED: ${{ secrets.NEXT_PUBLIC_ANALYTICS_DISABLED }}
  NEXT_PUBLIC_GA4_ID: ${{ secrets.NEXT_PUBLIC_GA4_ID }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js version
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Build
        run: npm run build

      - name: Test (if configured)
        run: npm run test --if-present

      - name: Validate build artifacts
        run: |
          if [ ! -d ".next/server" ]; then
            echo ".next/server is missing after build" >&2
            ls -la .next
            exit 1
          fi
          if [ ! -d ".next/static" ]; then
            echo ".next/static is missing after build" >&2
            exit 1
          fi

      - name: Prune dev dependencies for deployment
        run: npm prune --omit=dev

      - name: Create deployment bundle
        run: |
          mkdir -p deployment
          cp -r .next deployment/.next
          cp -r public deployment/public
          cp -r node_modules deployment/node_modules
          cp package.json package-lock.json next.config.ts middleware.ts build.js deployment/

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: deployment

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.slot) || 'production' }}
    
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app
          path: node-app

      - name: Resolve target slot and publish profile
        id: slot
        shell: bash
        run: |
          slot_input="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.slot || '' }}"
          if [ -z "$slot_input" ]; then
            slot_input="Production"
          fi
          slot_normalized="$(echo "$slot_input" | tr '[:upper:]' '[:lower:]')"
          if [ "$slot_normalized" != "production" ] && [ "$slot_normalized" != "staging" ]; then
            echo "Slot must be Production or staging; received '$slot_input'." >&2
            exit 1
          fi

          if [ "$slot_normalized" = "staging" ]; then
            if [ -z "${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_STAGING }}" ]; then
              echo "Staging slot requested but AZUREAPPSERVICE_PUBLISHPROFILE_STAGING is not configured." >&2
              exit 1
            fi
            echo "slot=staging" >> "$GITHUB_OUTPUT"
          else
            echo "slot=Production" >> "$GITHUB_OUTPUT"
          fi

      - name: Archive package
        run: |
          cd node-app
          zip -r ../node-app.zip .

      - name: 'Deploy to Azure Web App'
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_NAME }}
          slot-name: ${{ steps.slot.outputs.slot }}
          package: node-app.zip
          publish-profile: ${{ steps.slot.outputs.slot == 'staging' && secrets.AZUREAPPSERVICE_PUBLISHPROFILE_STAGING || secrets.AZUREAPPSERVICE_PUBLISHPROFILE_C1805A0956574B47AE4629B59BCC2619 }}
