module.exports=[42145,3071,a=>{"use strict";let b="Member of the public";function c(a){return!!(a&&"object"==typeof a&&"message"in a&&"string"==typeof a.message)}function d(a,b){return"42501"===b.code?Error("You do not have permission to modify this profile. Contact a moderator for support."):Error("We could not load your profile right now. Please try again.")}async function e(a,e,f){let g=a.schema("portal"),h=async()=>{let{data:a,error:b}=await g.from("profiles").select("*").eq("user_id",e).maybeSingle();if(b){if(c(b)&&"406"===b.code)throw Error("Multiple profiles are linked to this account. Please contact an administrator to resolve the duplicate profile before continuing.");if(c(b))throw d("fetch your profile",b);throw b}return a??null},i=async b=>{try{await a.rpc("refresh_user_permissions",{user_uuid:b})}catch(a){}},j=async a=>{if(a.position_title||"community_member"!==a.affiliation_type)return a;let{data:c,error:d}=await g.from("profiles").update({position_title:b}).eq("id",a.id).select("*").maybeSingle();return d?a:c??a},k=await h();if(k)return k.user_id&&await i(k.user_id),j(k);let{count:l,error:m}=await g.from("profiles").select("id",{count:"exact",head:!0}).eq("user_id",e);if(m){if(c(m))throw d("check your profile",m);throw m}if((l??0)>0)throw Error("Multiple profiles are linked to this account. Please contact an administrator to resolve the duplicate profile before continuing.");let n=f?.affiliation_type??"community_member",o="community_member"===n,p=f?.affiliation_status??(o?"approved":"pending"),q=f?.affiliation_requested_at??("pending"===p?new Date().toISOString():null),r=f?.position_title??(o?b:null),s=f?.homelessness_experience??"none",t=f?.substance_use_experience??"none",u={user_id:e,display_name:f?.display_name??"Community Member",organization_id:f?.organization_id??null,rules_acknowledged_at:f?.rules_acknowledged_at??null,position_title:r,affiliation_type:n,affiliation_status:p,affiliation_requested_at:q,affiliation_reviewed_at:f?.affiliation_reviewed_at??null,affiliation_reviewed_by:f?.affiliation_reviewed_by??null,bio:f?.bio??null,avatar_url:f?.avatar_url??null,homelessness_experience:s,substance_use_experience:t,government_role_type:f?.government_role_type??null,requested_organization_name:f?.requested_organization_name??null,requested_government_name:f?.requested_government_name??null,requested_government_level:f?.requested_government_level??null,requested_government_role:f?.requested_government_role??null},{data:v,error:w}=await g.from("profiles").insert(u).select("*").single();if(w){if(c(w)&&"23505"===w.code){let a=await h();if(a)return j(a)}if(c(w)&&"406"===w.code)throw Error("Multiple profiles are linked to this account. Please contact an administrator to resolve the duplicate profile before continuing.");if(c(w))throw d("create your profile",w);throw w}return await i(e),j(v)}async function f(a,b){let{data:c,error:d}=await a.rpc("portal_get_user_email",{p_profile_id:b});if(d)throw d;return c??null}a.s(["NEW_ORGANIZATION_VALUE",0,"__new_org__","NO_ORGANIZATION_VALUE",0,"__none__","PUBLIC_MEMBER_ROLE_LABEL",0,b],3071),a.s(["ensurePortalProfile",()=>e,"getUserEmailForProfile",()=>f],42145)},37936,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"registerServerReference",{enumerable:!0,get:function(){return d.registerServerReference}});let d=a.r(11857)},16349,a=>{"use strict";var b=a.i(5246);a.i(42537);var c=a.i(5860),d=a.i(31507);async function e(){let{url:a,anonKey:e}=(0,d.getSupabaseEnv)(),f=await (0,b.cookies)();return(0,c.createServerClient)(a,e,{cookies:{getAll:()=>f.getAll(),setAll(a){a.forEach(({name:a,value:b,options:c})=>{try{f.set(a,b,{path:"/",sameSite:"lax",httpOnly:!0,secure:!0,...c})}catch(a){}})}}})}a.s(["createSupabaseServerClient",()=>e])},12573,a=>{"use strict";async function b({supabase:a,type:b,limit:c,cooldownMs:d}){let{data:e,error:f}=await a.rpc("portal_check_rate_limit",{p_event:b,p_limit:c,p_cooldown_ms:d??null});if(f)throw f;let[g]=e??[];return!g||g.allowed?{allowed:!0,retryInMs:0}:{allowed:!1,retryInMs:Math.max(g.retry_in_ms??0,0)||1e3}}a.s(["checkRateLimit",()=>b])},6687,a=>{"use strict";function b(a){if("string"!=typeof a)return;let b=a.trim();if(!b)return;let c=b.startsWith("+"),d=b.replace(/\D+/g,"");if(d){if(c)return`+${d}`;if(10===d.length)return`+1${d}`;if(d.length>10)return`+${d}`}}function c(a){let c=b(a);if(!c)return"";let d=c.slice(-4),e=c.slice(0,Math.max(2,c.length-4)).replace(/\d/g,"*");return`${e}${d}`}a.s(["maskPhoneNumber",()=>c,"normalizePhoneNumber",()=>b])},9307,a=>{"use strict";function b(a,c="/home"){if(!a)return c;let d=Array.isArray(a)?a[0]:a;return!d||!d.startsWith("/")||d.startsWith("//")?c:d}function c(a){if(!a)return null;let b=Array.isArray(a)?a[0]:a;return"google_auth_cancelled"===b||"google_auth_error"===b?b:null}a.s(["parseAuthErrorCode",()=>c,"resolveNextPath",()=>b])},66680,(a,b,c)=>{b.exports=a.x("node:crypto",()=>require("node:crypto"))},82465,a=>{"use strict";var b=a.i(66680);let c="0123456789";function d(a=8){if(a<=0)throw Error("Portal code length must be greater than zero");let e="";for(let d=0;d<a;d+=1){let a=b.default.randomInt(0,c.length);e+=c[a]}return e}function e(a){if(!a)return null;let b=a.replace(/[^0-9A-Za-z]/g,"").toUpperCase();return b.length<=4?b:8===b.length?`${b.slice(0,4)}-${b.slice(4)}`:9===b.length?`${b.slice(0,3)}-${b.slice(3,6)}-${b.slice(6)}`:b}function f(a){if("string"!=typeof a)return null;let b=a.trim();return 0===b.length?null:b}function g(a){if(!a)return null;let b=a.replace(/[^0-9A-Za-z]/g,"").toUpperCase();return b?6===b.length?`${b.slice(0,3)} ${b.slice(3)}`:b:null}a.s(["emptyToNull",()=>f,"formatPortalCode",()=>e,"generatePortalCode",()=>d,"normalizePostalCode",()=>g])},37199,a=>{"use strict";var b=a.i(7997),c=a.i(39138);let d={"form-sm":"max-w-form-sm","form-md":"max-w-form-md","form-lg":"max-w-form-lg",xl:"max-w-page",page:"max-w-page"};function e({children:a,eyebrow:e,title:f,description:g,actions:h,maxWidth:i="form-lg",align:j="start",spacing:k="lg"}){let l="center"===j?"max-w-2xl":"max-w-3xl",m=!!(e||f||g||h);return(0,b.jsx)("div",{className:"page-shell",children:(0,b.jsxs)("div",{className:(0,c.cn)("mx-auto flex w-full flex-col","md"===k?"gap-space-lg":"gap-space-xl",d[i]),children:[m?(0,b.jsxs)("header",{className:(0,c.cn)("flex w-full flex-col gap-space-xs","center"===j?"items-center text-center":"items-start text-left"),children:[e?(0,b.jsx)("p",{className:"text-label-sm font-medium uppercase text-muted-foreground",children:e}):null,f?(0,b.jsx)("h1",{className:(0,c.cn)("text-headline-lg text-on-surface sm:text-display-sm",l),children:f}):null,g?"string"==typeof g?(0,b.jsx)("p",{className:(0,c.cn)("text-body-md text-muted-foreground sm:text-body-lg",l),children:g}):(0,b.jsx)("div",{className:(0,c.cn)("text-body-md text-muted-foreground sm:text-body-lg",l),children:g}):null,h?(0,b.jsx)("div",{className:"flex flex-wrap gap-space-sm pt-space-sm",children:h}):null]}):null,a]})})}a.s(["FormPageShell",()=>e])},83279,a=>{"use strict";var b=a.i(11857);let c=(0,b.registerClientReference)(function(){throw Error("Attempted to call CLIENT_CLAIM_INITIAL_STATE() from the server but CLIENT_CLAIM_INITIAL_STATE is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/app/register/_components/client-claim-form.tsx <module evaluation>","CLIENT_CLAIM_INITIAL_STATE"),d=(0,b.registerClientReference)(function(){throw Error("Attempted to call ClientClaimForm() from the server but ClientClaimForm is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/app/register/_components/client-claim-form.tsx <module evaluation>","ClientClaimForm");a.s(["CLIENT_CLAIM_INITIAL_STATE",0,c,"ClientClaimForm",0,d])},29790,a=>{"use strict";var b=a.i(11857);let c=(0,b.registerClientReference)(function(){throw Error("Attempted to call CLIENT_CLAIM_INITIAL_STATE() from the server but CLIENT_CLAIM_INITIAL_STATE is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/app/register/_components/client-claim-form.tsx","CLIENT_CLAIM_INITIAL_STATE"),d=(0,b.registerClientReference)(function(){throw Error("Attempted to call ClientClaimForm() from the server but ClientClaimForm is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/app/register/_components/client-claim-form.tsx","ClientClaimForm");a.s(["CLIENT_CLAIM_INITIAL_STATE",0,c,"ClientClaimForm",0,d])},16305,a=>{"use strict";a.i(83279);var b=a.i(29790);a.n(b)},98847,a=>{"use strict";var b=a.i(7997),c=a.i(37936);a.i(70396);var d=a.i(73727),e=a.i(16305),f=a.i(9307),g=a.i(82465),h=a.i(9919),i=a.i(16349),j=a.i(42145),k=a.i(6687),l=a.i(12573),m=a.i(37199);let n=async function(a,b){var c;let e="phone"===("string"==typeof(c=b.get("contact_method"))?c.trim().toLowerCase():"")?"phone":"email",h=(0,g.emptyToNull)(b.get("portal_code")),m=(0,g.emptyToNull)(b.get("chosen_name"))??"",n=p(b.get("dob_month")),o=p(b.get("dob_year")),q="email"===e?(0,g.emptyToNull)(b.get("contact_email")?.toLowerCase()??null):null,r="phone"===e?b.get("contact_phone"):null,s=r?(0,k.normalizePhoneNumber)(r)??null:null,t=b.get("password")??"",u=b.get("password_confirm")??"";if(!m||m.length<2)return{status:"idle",error:"Share the name that appears on your IHARC record."};if(!n||!o)return{status:"idle",error:"Share your birth month and year so we can match the right record."};if("email"===e&&!q)return{status:"idle",error:"Enter the email you would like to use for portal access."};if("phone"===e&&!s)return{status:"idle",error:"Enter a valid phone number with country code or switch to the email option."};if(!t||t.length<12)return{status:"idle",error:"Create a password with at least 12 characters."};if(t!==u)return{status:"idle",error:"Confirm that both password entries match."};let v="on"===b.get("consent_privacy"),w="on"===b.get("consent_terms"),x="on"===b.get("consent_contact");if(!v||!w||!x)return{status:"idle",error:"Consent to the privacy notice, terms, and safe contact before continuing."};if(2>[+!!h,m&&n&&o?1:0,+!!q,+!!s].reduce((a,b)=>a+b,0))return{status:"idle",error:"Share at least two pieces of information (code, name + birth month/year, email, or phone)."};let y=await (0,i.createSupabaseServerClient)(),z=await (0,l.checkRateLimit)({supabase:y,type:"registration_claim",limit:3,cooldownMs:3e5});if(!z.allowed){let a;return{status:"idle",error:(a=Math.max(1,Math.ceil(z.retryInMs/6e4)),`We’re receiving many requests. Please wait about ${a} minute${1===a?"":"s"} before trying again.`)}}let A=null,B=null,C=!1;try{if("phone"===e){let{data:a,error:b}=await y.auth.signUp({phone:s,password:t,options:{data:{display_name:m}}});if(b)return{status:"idle",error:b.message??"We could not create your account right now."};A=a.user?.id??null,C=!!a.session}else{let{data:a,error:b}=await y.auth.signUp({email:q,password:t,options:{emailRedirectTo:"https://stevi.iharc.ca/login",data:{display_name:m}}});if(b)return{status:"idle",error:b.message??"We could not create your account right now."};A=a.user?.id??null,C=!!a.session}}catch(a){if(a instanceof Error)return{status:"idle",error:a.message};return{status:"idle",error:"We could not create your account right now."}}if(!A)return{status:"idle",error:"We could not create your account right now. Try again later."};if(C)try{B=(await (0,j.ensurePortalProfile)(y,A,{display_name:m,affiliation_type:"community_member",position_title:"Client"})).id}catch(a){console.warn("Unable to create profile during client claim",a)}let D=function(a){if(!a)return null;let b=a.replace(/[^0-9A-Za-z]/g,"").toUpperCase();return b.length?b:null}(h);if(C&&B)try{let a=y.schema("portal"),{data:c,error:e}=await a.rpc("claim_registration_flow",{p_portal_code:D,p_chosen_name:m,p_date_of_birth_month:n,p_date_of_birth_year:o,p_contact_email:q,p_contact_phone:s});if(e)return console.error("claim_registration_flow error",e),{status:"idle",error:"We could not link your record right now. Please contact IHARC staff for assistance."};let g=Array.isArray(c)?c[0]:null;if(!g?.success){let a=g?.reason??"no_match",b=function(a){switch(a){case"no_match":return"We could not find a record that matches those details. Double-check the information or ask IHARC staff to help.";case"insufficient_match":return"We found a possible match, but need one more piece of information. Try adding your IHARC code or phone number.";case"insufficient_identifiers":return"Share at least two pieces of information (code, name with birth month/year, email, or phone).";default:return"We could not link your record right now. Please contact IHARC staff for assistance."}}(a);return{status:"idle",error:b}}let h=b.get("next"),i=(0,f.resolveNextPath)("string"==typeof h?h:void 0);(0,d.redirect)(i)}catch(a){return console.error("Unexpected error claiming registration",a),{status:"idle",error:"We could not link your record right now. Please contact IHARC staff for assistance."}}let E={chosen_name:m,dob_month:n,dob_year:o,contact_method:e,masked_phone:s?(0,k.maskPhoneNumber)(s):null},F=y.schema("portal"),{error:G}=await F.from("registration_flows").insert({flow_type:"client_claim",status:"pending",portal_code:D??(0,g.generatePortalCode)(),chosen_name:m,contact_email:q,contact_phone:s,metadata:E,supabase_user_id:A,profile_id:B,consent_data_sharing:v,consent_contact:x,consent_terms:w});return G&&console.error("Unable to store client claim request",G),{status:"success",portalCode:(0,g.formatPortalCode)(D??void 0),message:"phone"===e?"Check your phone for a verification link. After you confirm, sign in again so we can finish linking your record.":"Check your email for a verification link. After you confirm, sign in again and we’ll finish linking your record."}};async function o({searchParams:a}){let c=a?await a:void 0,g=(0,f.resolveNextPath)(c?.next),i=await (0,h.createSupabaseRSCClient)(),{data:{user:j}}=await i.auth.getUser();return j&&(0,d.redirect)(g),(0,b.jsx)(m.FormPageShell,{maxWidth:"form-lg",children:(0,b.jsx)(e.ClientClaimForm,{action:n,initialState:e.CLIENT_CLAIM_INITIAL_STATE,nextPath:g})})}function p(a){if("string"!=typeof a)return null;let b=a.trim();if(!b)return null;let c=Number.parseInt(b,10);return Number.isNaN(c)?null:c}(0,c.registerServerReference)(n,"60894558e64bfabacf723d29c49991c24a0f518ebf",null),a.s(["$$RSC_SERVER_ACTION_0",0,n,"default",()=>o,"dynamic",0,"force-dynamic"])},76648,a=>{"use strict";var b=a.i(98847);a.s([],29869),a.i(29869),a.s(["60894558e64bfabacf723d29c49991c24a0f518ebf",()=>b.$$RSC_SERVER_ACTION_0],76648)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__695b7a92._.js.map