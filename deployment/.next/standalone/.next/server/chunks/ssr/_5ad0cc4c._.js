module.exports=[63985,a=>{"use strict";let b="[redacted]",c=["password","token","secret","authorization","cookie","session","otp","code","sin","ssn","birth","dob","email","phone","contact","address"];function d(a){if(null===a||"object"!=typeof a)return!1;let b=Object.getPrototypeOf(a);return b===Object.prototype||null===b}let e=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,f=/^[0-9]+$/,g=/^[a-z0-9_]+$/i,h=/^[a-zA-Z0-9._:-]+$/;function i(a){if(null==a)return null;let b="number"==typeof a?String(a):a.trim?.()??a;return"string"!=typeof b||0===b.length?null:e.test(b)||f.test(b)?b:b.slice(0,128)}function j(a){let b=i(a);return b&&e.test(b)?b:null}function k(a){if(!a)return null;let{schema:b,table:c,id:d}=a;if(!g.test(b)||!g.test(c))return null;let e=i(d);return e&&h.test(e)?`${b.toLowerCase()}.${c.toLowerCase()}:${e}`:null}async function l(a,{actorProfileId:e=null,action:f,entityType:g,entityRef:h,entityId:i,meta:l}){let m=l&&d(l)?function a(e,f){let g={};return Object.entries(e).forEach(([e,h])=>{let i;if(i=e.toLowerCase(),c.some(a=>i.includes(a))){g[e]=b;return}let j=function c(e,f){if(void 0!==e){if(null===e)return null;if("string"==typeof e)return e.length>1024?`${e.slice(0,1024)}...`:e;if("number"==typeof e||"boolean"==typeof e)return e;if("bigint"==typeof e)return e.toString();if(e instanceof Date)return e.toISOString();if(e instanceof URL)return e.toString();if(e instanceof Error)return{name:e.name,message:e.message};if(Array.isArray(e))return e.map(a=>c(a,f)).filter(a=>void 0!==a);if(e instanceof Set)return Array.from(e).map(a=>c(a,f)).filter(a=>void 0!==a);if(e instanceof Map){let a={};return e.forEach((b,d)=>{let e=c(b,f);void 0!==e&&(a[String(d)]=e)}),a}return"object"==typeof e&&d(e)?f.has(e)?b:(f.add(e),a(e,f)):String(e)}}(h,f);void 0!==j&&(g[e]=j)}),g}(l,new WeakSet):{},n="string"==typeof h?h:k(h),o=j(i);!o&&n&&(o=j(n.split(":").pop()??null));let p=!n||"entity_ref"in m?m:{...m,entity_ref:n},q=j(e),{error:r}=await a.rpc("portal_log_audit_event",{p_action:f,p_entity_type:g,p_entity_id:o,p_meta:p,p_actor_profile_id:q});if(r)throw r}a.s(["buildEntityRef",()=>k,"logAuditEvent",()=>l],63985)},13095,(a,b,c)=>{"use strict";function d(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"ensureServerEntryExports",{enumerable:!0,get:function(){return d}})},83425,a=>{"use strict";var b=a.i(86731),c=a.i(37936),d=a.i(18558),e=a.i(16349),f=a.i(63985),g=a.i(3071),h=a.i(42145),i=a.i(65108),j=a.i(13095);let k=["/admin","/admin/profiles"];async function l(){await Promise.all(k.map(a=>(0,d.revalidatePath)(a)))}function m(a,b){let c=a.get(b);if("string"!=typeof c)return null;let d=c.trim();return d.length?d:null}function n(a,b,c){let d=m(a,b);if(!d)throw Error(c);return d}function o(a){if("string"!=typeof a)return null;let b=a.trim();if(!b||b===g.NO_ORGANIZATION_VALUE)return null;let c=Number.parseInt(b,10);return Number.isNaN(c)?null:c}function p(a){return a instanceof Error?a.message:"string"==typeof a?a:"Something went wrong. Try again in a moment."}async function q(){let a=await (0,e.createSupabaseServerClient)(),b=await (0,i.loadPortalAccess)(a);if(!b)throw Error("Sign in to continue.");if(!b.canReviewProfiles)throw Error("Moderator access is required.");let c=await (0,h.ensurePortalProfile)(a,b.userId),d=a.schema("portal");return{supabase:a,portal:d,userId:b.userId,actorProfile:c}}async function r(a){try{let b=n(a,"invite_email","Enter the contact email."),c=m(a,"invite_display_name"),d=m(a,"invite_position_title"),e=m(a,"invite_affiliation_type")??"agency_partner",f=m(a,"invite_message"),g=o(a.get("invite_organization_id")),h=["community_member","agency_partner","government_partner"].includes(e)?e:"agency_partner";if(!b.includes("@"))throw Error("Provide a valid email address.");let i=await q(),{data:j,error:k}=await i.supabase.auth.getSession();if(k||!j.session?.access_token)throw k??Error("Current session missing. Refresh and try again.");let p=await i.supabase.functions.invoke("portal-admin-invite",{body:{email:b,displayName:c,positionTitle:d,affiliationType:h,organizationId:g,message:f,actorProfileId:i.actorProfile.id},headers:{Authorization:`Bearer ${j.session.access_token}`}});if(p.error)throw Error(p.error.message||"Failed to send the invitation.");return await l(),{success:!0}}catch(a){return console.error("sendPartnerInviteAction error",a),{success:!1,error:p(a)}}}async function s(a){try{let b=n(a,"profile_id","Profile context is required."),c=o(a.get("approved_organization_id")),d=m(a,"approved_government_role"),{supabase:e,portal:g,actorProfile:h}=await q(),{data:i,error:j}=await g.from("profiles").select("user_id, affiliation_type, organization_id, requested_organization_name, requested_government_name, requested_government_level, requested_government_role, government_role_type").eq("id",b).maybeSingle();if(j||!i)throw j??Error("Profile not found.");let k=new Date().toISOString(),p=null,r=null;if("agency_partner"===i.affiliation_type){if(!c)throw Error("Select an organization before approving.");p=c}else if("government_partner"===i.affiliation_type){if(!c)throw Error("Select a government partner before approving.");p=c,r=function(a){if(!a)throw Error("Select a government role type.");if(!["staff","politician"].includes(a))throw Error("Invalid government role selection.");return a}(d)}let s="community_member"!==i.affiliation_type,t={affiliation_status:"approved",affiliation_reviewed_at:k,affiliation_reviewed_by:h.id,organization_id:p,government_role_type:r,requested_organization_name:null,requested_government_name:null,requested_government_level:null,requested_government_role:null},{error:v}=await g.from("profiles").update(t).eq("id",b);if(v)throw v;return await u(e,b,s),await (0,f.logAuditEvent)(e,{actorProfileId:h.id,action:"profile_affiliation_approved",entityType:"profile",entityRef:(0,f.buildEntityRef)({schema:"portal",table:"profiles",id:b}),meta:{affiliation_type:i.affiliation_type,organization_id:p,government_role:r}}),await l(),{success:!0}}catch(a){return console.error("approveAffiliationAction error",a),{success:!1,error:p(a)}}}async function t(a){try{let b=n(a,"profile_id","Profile context is required."),{supabase:c,portal:d,actorProfile:e}=await q(),{data:g,error:i}=await d.from("profiles").select("user_id, affiliation_type").eq("id",b).maybeSingle();if(i||!g)throw i??Error("Profile not found.");let j=new Date().toISOString(),k={affiliation_status:"revoked",affiliation_reviewed_at:j,affiliation_reviewed_by:e.id,requested_organization_name:null,requested_government_name:null,requested_government_level:null,requested_government_role:null};"community_member"!==g.affiliation_type&&(k.organization_id=null,k.government_role_type=null);let{error:m}=await d.from("profiles").update(k).eq("id",b);if(m)throw m;return await u(c,b,!1),g.user_id&&await (0,h.ensurePortalProfile)(c,g.user_id).catch(a=>{console.warn("Failed to refresh portal profile cache",a)}),await (0,f.logAuditEvent)(c,{actorProfileId:e.id,action:"profile_affiliation_declined",entityType:"profile",entityRef:(0,f.buildEntityRef)({schema:"portal",table:"profiles",id:b})}),await l(),{success:!0}}catch(a){return console.error("declineAffiliationAction error",a),{success:!1,error:p(a)}}}async function u(a,b,c){let d=a.schema("portal"),{error:e}=await d.rpc("set_profile_role",{p_profile_id:b,p_role_name:"portal_org_rep",p_enable:c});if(e)throw e}(0,j.ensureServerEntryExports)([r,s,t]),(0,c.registerServerReference)(r,"4032dce19b8b87f0663a56aa897070457e5b0b602f",null),(0,c.registerServerReference)(s,"40175a4fa4efa69d13085bdd92ae58ef2d5f9a5e3a",null),(0,c.registerServerReference)(t,"40ec3bc3c38d1a6d033ae0320975f8577a432306a9",null),a.s([],19192),a.i(19192),a.s(["00b7ee4fee263fec1fe8acb860989f6ddb47485e3a",()=>b.$$RSC_SERVER_ACTION_0,"40175a4fa4efa69d13085bdd92ae58ef2d5f9a5e3a",()=>s,"4032dce19b8b87f0663a56aa897070457e5b0b602f",()=>r,"40ec3bc3c38d1a6d033ae0320975f8577a432306a9",()=>t],83425)}];

//# sourceMappingURL=_5ad0cc4c._.js.map