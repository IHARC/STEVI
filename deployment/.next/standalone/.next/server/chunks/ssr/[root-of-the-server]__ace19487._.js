module.exports=[42145,3071,a=>{"use strict";let b="Member of the public";function c(a){return!!(a&&"object"==typeof a&&"message"in a&&"string"==typeof a.message)}function d(a,b){return"42501"===b.code?Error("You do not have permission to modify this profile. Contact a moderator for support."):Error("We could not load your profile right now. Please try again.")}async function e(a,e,f){let g=a.schema("portal"),h=async()=>{let{data:a,error:b}=await g.from("profiles").select("*").eq("user_id",e).maybeSingle();if(b){if(c(b)&&"406"===b.code)throw Error("Multiple profiles are linked to this account. Please contact an administrator to resolve the duplicate profile before continuing.");if(c(b))throw d("fetch your profile",b);throw b}return a??null},i=async b=>{try{await a.rpc("refresh_user_permissions",{user_uuid:b})}catch(a){}},j=async a=>{if(a.position_title||"community_member"!==a.affiliation_type)return a;let{data:c,error:d}=await g.from("profiles").update({position_title:b}).eq("id",a.id).select("*").maybeSingle();return d?a:c??a},k=await h();if(k)return k.user_id&&await i(k.user_id),j(k);let{count:l,error:m}=await g.from("profiles").select("id",{count:"exact",head:!0}).eq("user_id",e);if(m){if(c(m))throw d("check your profile",m);throw m}if((l??0)>0)throw Error("Multiple profiles are linked to this account. Please contact an administrator to resolve the duplicate profile before continuing.");let n=f?.affiliation_type??"community_member",o="community_member"===n,p=f?.affiliation_status??(o?"approved":"pending"),q=f?.affiliation_requested_at??("pending"===p?new Date().toISOString():null),r=f?.position_title??(o?b:null),s=f?.homelessness_experience??"none",t=f?.substance_use_experience??"none",u={user_id:e,display_name:f?.display_name??"Community Member",organization_id:f?.organization_id??null,rules_acknowledged_at:f?.rules_acknowledged_at??null,position_title:r,affiliation_type:n,affiliation_status:p,affiliation_requested_at:q,affiliation_reviewed_at:f?.affiliation_reviewed_at??null,affiliation_reviewed_by:f?.affiliation_reviewed_by??null,bio:f?.bio??null,avatar_url:f?.avatar_url??null,homelessness_experience:s,substance_use_experience:t,government_role_type:f?.government_role_type??null,requested_organization_name:f?.requested_organization_name??null,requested_government_name:f?.requested_government_name??null,requested_government_level:f?.requested_government_level??null,requested_government_role:f?.requested_government_role??null},{data:v,error:w}=await g.from("profiles").insert(u).select("*").single();if(w){if(c(w)&&"23505"===w.code){let a=await h();if(a)return j(a)}if(c(w)&&"406"===w.code)throw Error("Multiple profiles are linked to this account. Please contact an administrator to resolve the duplicate profile before continuing.");if(c(w))throw d("create your profile",w);throw w}return await i(e),j(v)}async function f(a,b){let{data:c,error:d}=await a.rpc("portal_get_user_email",{p_profile_id:b});if(d)throw d;return c??null}a.s(["NEW_ORGANIZATION_VALUE",0,"__new_org__","NO_ORGANIZATION_VALUE",0,"__none__","PUBLIC_MEMBER_ROLE_LABEL",0,b],3071),a.s(["ensurePortalProfile",()=>e,"getUserEmailForProfile",()=>f],42145)},37936,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"registerServerReference",{enumerable:!0,get:function(){return d.registerServerReference}});let d=a.r(11857)},16349,a=>{"use strict";var b=a.i(5246);a.i(42537);var c=a.i(5860),d=a.i(31507);async function e(){let{url:a,anonKey:e}=(0,d.getSupabaseEnv)(),f=await (0,b.cookies)();return(0,c.createServerClient)(a,e,{cookies:{getAll:()=>f.getAll(),setAll(a){a.forEach(({name:a,value:b,options:c})=>{try{f.set(a,b,{path:"/",sameSite:"lax",httpOnly:!0,secure:!0,...c})}catch(a){}})}}})}a.s(["createSupabaseServerClient",()=>e])},9307,a=>{"use strict";function b(a,c="/home"){if(!a)return c;let d=Array.isArray(a)?a[0]:a;return!d||!d.startsWith("/")||d.startsWith("//")?c:d}function c(a){if(!a)return null;let b=Array.isArray(a)?a[0]:a;return"google_auth_cancelled"===b||"google_auth_error"===b?b:null}a.s(["parseAuthErrorCode",()=>c,"resolveNextPath",()=>b])},66680,(a,b,c)=>{b.exports=a.x("node:crypto",()=>require("node:crypto"))},82465,a=>{"use strict";var b=a.i(66680);let c="0123456789";function d(a=8){if(a<=0)throw Error("Portal code length must be greater than zero");let e="";for(let d=0;d<a;d+=1){let a=b.default.randomInt(0,c.length);e+=c[a]}return e}function e(a){if(!a)return null;let b=a.replace(/[^0-9A-Za-z]/g,"").toUpperCase();return b.length<=4?b:8===b.length?`${b.slice(0,4)}-${b.slice(4)}`:9===b.length?`${b.slice(0,3)}-${b.slice(3,6)}-${b.slice(6)}`:b}function f(a){if("string"!=typeof a)return null;let b=a.trim();return 0===b.length?null:b}function g(a){if(!a)return null;let b=a.replace(/[^0-9A-Za-z]/g,"").toUpperCase();return b?6===b.length?`${b.slice(0,3)} ${b.slice(3)}`:b:null}a.s(["emptyToNull",()=>f,"formatPortalCode",()=>e,"generatePortalCode",()=>d,"normalizePostalCode",()=>g])},37199,a=>{"use strict";var b=a.i(7997),c=a.i(39138);let d={"form-sm":"max-w-form-sm","form-md":"max-w-form-md","form-lg":"max-w-form-lg",xl:"max-w-page",page:"max-w-page"};function e({children:a,eyebrow:e,title:f,description:g,actions:h,maxWidth:i="form-lg",align:j="start",spacing:k="lg"}){let l="center"===j?"max-w-2xl":"max-w-3xl",m=!!(e||f||g||h);return(0,b.jsx)("div",{className:"page-shell",children:(0,b.jsxs)("div",{className:(0,c.cn)("mx-auto flex w-full flex-col","md"===k?"gap-space-lg":"gap-space-xl",d[i]),children:[m?(0,b.jsxs)("header",{className:(0,c.cn)("flex w-full flex-col gap-space-xs","center"===j?"items-center text-center":"items-start text-left"),children:[e?(0,b.jsx)("p",{className:"text-label-sm font-medium uppercase text-muted-foreground",children:e}):null,f?(0,b.jsx)("h1",{className:(0,c.cn)("text-headline-lg text-on-surface sm:text-display-sm",l),children:f}):null,g?"string"==typeof g?(0,b.jsx)("p",{className:(0,c.cn)("text-body-md text-muted-foreground sm:text-body-lg",l),children:g}):(0,b.jsx)("div",{className:(0,c.cn)("text-body-md text-muted-foreground sm:text-body-lg",l),children:g}):null,h?(0,b.jsx)("div",{className:"flex flex-wrap gap-space-sm pt-space-sm",children:h}):null]}):null,a]})})}a.s(["FormPageShell",()=>e])},37849,a=>{"use strict";var b=a.i(11857);let c=(0,b.registerClientReference)(function(){throw Error("Attempted to call COMMUNITY_REGISTRATION_INITIAL_STATE() from the server but COMMUNITY_REGISTRATION_INITIAL_STATE is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/app/register/_components/community-registration-form.tsx <module evaluation>","COMMUNITY_REGISTRATION_INITIAL_STATE"),d=(0,b.registerClientReference)(function(){throw Error("Attempted to call CommunityRegistrationForm() from the server but CommunityRegistrationForm is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/app/register/_components/community-registration-form.tsx <module evaluation>","CommunityRegistrationForm");a.s(["COMMUNITY_REGISTRATION_INITIAL_STATE",0,c,"CommunityRegistrationForm",0,d])},14793,a=>{"use strict";var b=a.i(11857);let c=(0,b.registerClientReference)(function(){throw Error("Attempted to call COMMUNITY_REGISTRATION_INITIAL_STATE() from the server but COMMUNITY_REGISTRATION_INITIAL_STATE is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/app/register/_components/community-registration-form.tsx","COMMUNITY_REGISTRATION_INITIAL_STATE"),d=(0,b.registerClientReference)(function(){throw Error("Attempted to call CommunityRegistrationForm() from the server but CommunityRegistrationForm is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/app/register/_components/community-registration-form.tsx","CommunityRegistrationForm");a.s(["COMMUNITY_REGISTRATION_INITIAL_STATE",0,c,"CommunityRegistrationForm",0,d])},69705,a=>{"use strict";a.i(37849);var b=a.i(14793);a.n(b)},51709,a=>{"use strict";var b=a.i(7997),c=a.i(37936);a.i(70396);var d=a.i(73727),e=a.i(69705),f=a.i(9307),g=a.i(82465),h=a.i(9919),i=a.i(16349),j=a.i(42145),k=a.i(37199);let l=async function(a,b){let c=(0,g.emptyToNull)(b.get("display_name"))??"",e=(0,g.emptyToNull)(b.get("email")?.toLowerCase()??null),h=b.get("password")??"",k=b.get("password_confirm")??"",l="on"===b.get("consent_privacy"),m="on"===b.get("consent_terms"),n="on"===b.get("consent_updates");if(!c||c.length<2)return{status:"idle",error:"Share the name you would like other neighbours to see."};if(!e)return{status:"idle",error:"Enter the email address you want to use for IHARC updates."};if(!h||h.length<12)return{status:"idle",error:"Create a password with at least 12 characters."};if(h!==k)return{status:"idle",error:"Confirm that both password entries match."};if(!l||!m)return{status:"idle",error:"Consent to the privacy notice and terms before continuing. You can review them any time."};let o=await (0,i.createSupabaseServerClient)(),p=null,q=null,r=!1;try{let{data:a,error:b}=await o.auth.signUp({email:e,password:h,options:{emailRedirectTo:"https://stevi.iharc.ca/login",data:{display_name:c}}});if(b)return{status:"idle",error:b.message??"We could not create your account right now."};p=a.user?.id??null,r=!!a.session}catch(a){if(a instanceof Error)return{status:"idle",error:a.message};return{status:"idle",error:"We could not create your account right now."}}if(!p)return{status:"idle",error:"We could not create your account right now. Try again later."};if(r)try{q=(await (0,j.ensurePortalProfile)(o,p,{display_name:c,affiliation_type:"community_member"})).id}catch(a){console.warn("Unable to ensure community profile during registration",a)}let s=o.schema("portal"),{error:t}=await s.from("registration_flows").insert({flow_type:"community_registration",status:"submitted",chosen_name:c,contact_email:e,consent_data_sharing:l,consent_contact:n,consent_terms:m,metadata:{consent_updates:n},supabase_user_id:p,profile_id:q});if(t&&console.error("Failed to store community registration submission",t),r&&q){let a=b.get("next"),c=(0,f.resolveNextPath)("string"==typeof a?a:void 0);(0,d.redirect)(c)}return{status:"success",message:"Check your email for a confirmation link. Once verified, you can sign in to manage notification preferences."}};async function m({searchParams:a}){let c=a?await a:void 0,g=(0,f.resolveNextPath)(c?.next),i=await (0,h.createSupabaseRSCClient)(),{data:{user:j}}=await i.auth.getUser();return j&&(0,d.redirect)(g),(0,b.jsx)(k.FormPageShell,{maxWidth:"form-md",children:(0,b.jsx)(e.CommunityRegistrationForm,{action:l,initialState:e.COMMUNITY_REGISTRATION_INITIAL_STATE,nextPath:g})})}(0,c.registerServerReference)(l,"6024ed09714e2be8f2a2a7af876f418bb934a89990",null),a.s(["$$RSC_SERVER_ACTION_0",0,l,"default",()=>m,"dynamic",0,"force-dynamic"])},47570,a=>{"use strict";var b=a.i(51709);a.s([],48862),a.i(48862),a.s(["6024ed09714e2be8f2a2a7af876f418bb934a89990",()=>b.$$RSC_SERVER_ACTION_0],47570)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__ace19487._.js.map