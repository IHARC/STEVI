module.exports=[63985,a=>{"use strict";let b="[redacted]",c=["password","token","secret","authorization","cookie","session","otp","code","sin","ssn","birth","dob","email","phone","contact","address"];function d(a){if(null===a||"object"!=typeof a)return!1;let b=Object.getPrototypeOf(a);return b===Object.prototype||null===b}let e=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,f=/^[0-9]+$/,g=/^[a-z0-9_]+$/i,h=/^[a-zA-Z0-9._:-]+$/;function i(a){if(null==a)return null;let b="number"==typeof a?String(a):a.trim?.()??a;return"string"!=typeof b||0===b.length?null:e.test(b)||f.test(b)?b:b.slice(0,128)}function j(a){let b=i(a);return b&&e.test(b)?b:null}function k(a){if(!a)return null;let{schema:b,table:c,id:d}=a;if(!g.test(b)||!g.test(c))return null;let e=i(d);return e&&h.test(e)?`${b.toLowerCase()}.${c.toLowerCase()}:${e}`:null}async function l(a,{actorProfileId:e=null,action:f,entityType:g,entityRef:h,entityId:i,meta:l}){let m=l&&d(l)?function a(e,f){let g={};return Object.entries(e).forEach(([e,h])=>{let i;if(i=e.toLowerCase(),c.some(a=>i.includes(a))){g[e]=b;return}let j=function c(e,f){if(void 0!==e){if(null===e)return null;if("string"==typeof e)return e.length>1024?`${e.slice(0,1024)}...`:e;if("number"==typeof e||"boolean"==typeof e)return e;if("bigint"==typeof e)return e.toString();if(e instanceof Date)return e.toISOString();if(e instanceof URL)return e.toString();if(e instanceof Error)return{name:e.name,message:e.message};if(Array.isArray(e))return e.map(a=>c(a,f)).filter(a=>void 0!==a);if(e instanceof Set)return Array.from(e).map(a=>c(a,f)).filter(a=>void 0!==a);if(e instanceof Map){let a={};return e.forEach((b,d)=>{let e=c(b,f);void 0!==e&&(a[String(d)]=e)}),a}return"object"==typeof e&&d(e)?f.has(e)?b:(f.add(e),a(e,f)):String(e)}}(h,f);void 0!==j&&(g[e]=j)}),g}(l,new WeakSet):{},n="string"==typeof h?h:k(h),o=j(i);!o&&n&&(o=j(n.split(":").pop()??null));let p=!n||"entity_ref"in m?m:{...m,entity_ref:n},q=j(e),{error:r}=await a.rpc("portal_log_audit_event",{p_action:f,p_entity_type:g,p_entity_id:o,p_meta:p,p_actor_profile_id:q});if(r)throw r}a.s(["buildEntityRef",()=>k,"logAuditEvent",()=>l],63985)},13095,(a,b,c)=>{"use strict";function d(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"ensureServerEntryExports",{enumerable:!0,get:function(){return d}})},67230,a=>{"use strict";async function b(a,b){let{profileId:c=null,email:d=null,subject:e,bodyText:f,bodyHtml:g,type:h,payload:i}=b,{data:j,error:k}=await a.rpc("portal_queue_notification",{p_subject:e,p_body_text:f,p_profile_id:c,p_body_html:g??null,p_type:h,p_payload:i??{},p_recipient_email:d});if(k)throw k;let l=process.env.PORTAL_ALERTS_SECRET;if(l&&j)try{await a.functions.invoke("portal-alerts",{body:{notificationId:j},headers:{Authorization:`Bearer ${l}`}})}catch(a){console.error("Failed to invoke portal-alerts edge function",a)}return j}a.s(["queuePortalNotification",()=>b])},99741,a=>{"use strict";var b=a.i(86731),c=a.i(37936),d=a.i(18558),e=a.i(16349),f=a.i(63985),g=a.i(67230),h=a.i(42145),i=a.i(65108),j=a.i(13095);let k=["/admin","/admin/notifications"];function l(a,b){let c=a.get(b);if("string"!=typeof c)return null;let d=c.trim();return d.length?d:null}function m(a,b,c){let d=l(a,b);if(!d)throw Error(c);return d}function n(a){return a instanceof Error?a.message:"string"==typeof a?a:"Unable to send notification. Try again shortly."}async function o(){let a=await (0,e.createSupabaseServerClient)(),b=await (0,i.loadPortalAccess)(a);if(!b)throw Error("Sign in to send notifications.");if(!b.canManageNotifications)throw Error("Only admins can send notifications.");let c=await (0,h.ensurePortalProfile)(a,b.userId);return{supabase:a,actorProfile:c}}async function p(a,b){let{error:c}=await a.schema("portal").from("notification_relays").upsert({channel:b.channel,provider:b.provider,api_url:b.apiUrl,api_key:b.apiKey,from_email:b.fromEmail,from_phone:b.fromPhone,is_active:b.isActive??!0},{onConflict:"channel"});if(c)throw c}async function q(a){try{let{supabase:b,actorProfile:c}=await o(),e=function(a){let b=l(a,"channel")??"email",c=l(a,"provider");if(!c)throw Error("Provider name is required.");return{channel:b,provider:c,apiUrl:l(a,"api_url"),apiKey:l(a,"api_key"),fromEmail:l(a,"from_email"),fromPhone:l(a,"from_phone"),isActive:"true"===l(a,"is_active")}}(a);return await p(b,e),await (0,f.logAuditEvent)(b,{actorProfileId:c.id,action:"notification_relay_saved",entityType:"notification_relay",entityRef:(0,f.buildEntityRef)({schema:"portal",table:"notifications",id:e.channel}),meta:{channel:e.channel,provider:e.provider}}),await Promise.all(k.map(a=>(0,d.revalidatePath)(a))),{success:!0}}catch(a){return console.error("upsertRelayAction error",a),{success:!1,error:n(a)}}}async function r(a){try{let b=m(a,"subject","Add a subject line."),c=m(a,"body_text","Add the plain text body."),e=l(a,"body_html"),i=l(a,"notification_type")??"general",j=l(a,"payload_json"),n=l(a,"recipient_profile_id"),p=l(a,"recipient_email"),q="true"===l(a,"is_test");if(!n&&!p)throw Error("Select a recipient or provide an email address.");if(q&&!process.env.PORTAL_ALERTS_SECRET)throw Error("Configure PORTAL_ALERTS_SECRET before sending test notifications.");let{supabase:r,actorProfile:s}=await o(),t=p?.toLowerCase()??null;if(!t&&n&&(t=await (0,h.getUserEmailForProfile)(r,n)),!t)throw Error("Recipient email is required. Update their profile before sending.");let u=function(a){if(!a)return null;try{let b=JSON.parse(a);return"object"==typeof b&&null!==b?b:null}catch{throw Error("Payload must be valid JSON.")}}(j),v=q?`[TEST] ${b}`:b,w=q?"test":i;return await (0,g.queuePortalNotification)(r,{profileId:n,email:t,subject:v,bodyText:c,bodyHtml:e??void 0,type:w,payload:u??void 0}),await (0,f.logAuditEvent)(r,{actorProfileId:s.id,action:"notification_queued",entityType:"notification",entityRef:null,meta:{recipient_profile_id:n,recipient_email:t,notification_type:w,is_test:q}}),await Promise.all(k.map(a=>(0,d.revalidatePath)(a))),{success:!0}}catch(a){return console.error("sendNotificationAction error",a),{success:!1,error:n(a)}}}(0,j.ensureServerEntryExports)([q,r]),(0,c.registerServerReference)(q,"4023de9a73ed1fc562c739a8b9d926e6aa5e926e38",null),(0,c.registerServerReference)(r,"40d2fdb7c3d2c6140d23500beb4148ad3908a86db6",null),a.s([],13524),a.i(13524),a.s(["00b7ee4fee263fec1fe8acb860989f6ddb47485e3a",()=>b.$$RSC_SERVER_ACTION_0,"4023de9a73ed1fc562c739a8b9d926e6aa5e926e38",()=>q,"40d2fdb7c3d2c6140d23500beb4148ad3908a86db6",()=>r],99741)}];

//# sourceMappingURL=_bf96b32f._.js.map