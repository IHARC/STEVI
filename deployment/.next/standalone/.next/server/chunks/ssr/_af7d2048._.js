module.exports=[63985,a=>{"use strict";let b="[redacted]",c=["password","token","secret","authorization","cookie","session","otp","code","sin","ssn","birth","dob","email","phone","contact","address"];function d(a){if(null===a||"object"!=typeof a)return!1;let b=Object.getPrototypeOf(a);return b===Object.prototype||null===b}let e=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,f=/^[0-9]+$/,g=/^[a-z0-9_]+$/i,h=/^[a-zA-Z0-9._:-]+$/;function i(a){if(null==a)return null;let b="number"==typeof a?String(a):a.trim?.()??a;return"string"!=typeof b||0===b.length?null:e.test(b)||f.test(b)?b:b.slice(0,128)}function j(a){let b=i(a);return b&&e.test(b)?b:null}function k(a){if(!a)return null;let{schema:b,table:c,id:d}=a;if(!g.test(b)||!g.test(c))return null;let e=i(d);return e&&h.test(e)?`${b.toLowerCase()}.${c.toLowerCase()}:${e}`:null}async function l(a,{actorProfileId:e=null,action:f,entityType:g,entityRef:h,entityId:i,meta:l}){let m=l&&d(l)?function a(e,f){let g={};return Object.entries(e).forEach(([e,h])=>{let i;if(i=e.toLowerCase(),c.some(a=>i.includes(a))){g[e]=b;return}let j=function c(e,f){if(void 0!==e){if(null===e)return null;if("string"==typeof e)return e.length>1024?`${e.slice(0,1024)}...`:e;if("number"==typeof e||"boolean"==typeof e)return e;if("bigint"==typeof e)return e.toString();if(e instanceof Date)return e.toISOString();if(e instanceof URL)return e.toString();if(e instanceof Error)return{name:e.name,message:e.message};if(Array.isArray(e))return e.map(a=>c(a,f)).filter(a=>void 0!==a);if(e instanceof Set)return Array.from(e).map(a=>c(a,f)).filter(a=>void 0!==a);if(e instanceof Map){let a={};return e.forEach((b,d)=>{let e=c(b,f);void 0!==e&&(a[String(d)]=e)}),a}return"object"==typeof e&&d(e)?f.has(e)?b:(f.add(e),a(e,f)):String(e)}}(h,f);void 0!==j&&(g[e]=j)}),g}(l,new WeakSet):{},n="string"==typeof h?h:k(h),o=j(i);!o&&n&&(o=j(n.split(":").pop()??null));let p=!n||"entity_ref"in m?m:{...m,entity_ref:n},q=j(e),{error:r}=await a.rpc("portal_log_audit_event",{p_action:f,p_entity_type:g,p_entity_id:o,p_meta:p,p_actor_profile_id:q});if(r)throw r}a.s(["buildEntityRef",()=>k,"logAuditEvent",()=>l],63985)},13095,(a,b,c)=>{"use strict";function d(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"ensureServerEntryExports",{enumerable:!0,get:function(){return d}})},49701,a=>{"use strict";var b=a.i(37936),c=a.i(18558),d=a.i(16349),e=a.i(65108),f=a.i(63985);function g(a){return a.toLowerCase().trim().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,80)||`donation-${Date.now()}`}async function h(){let a=await (0,d.createSupabaseServerClient)(),b=await (0,e.loadPortalAccess)(a);if(!b)throw Error("Sign in to continue.");if(!b.iharcRoles.includes("iharc_admin"))throw Error("IHARC admin access is required.");return{supabase:a,donationsClient:a.schema("donations"),actorProfileId:b.profile.id}}async function i(a){let{supabase:b,donationsClient:d,actorProfileId:e}=await h(),i=a.get("id")?.trim()||null,j=a.get("title")?.trim()??"";if(!j)throw Error("Add a title for this item.");let k=g((a.get("slug")?.trim()??"")||j),l=a.get("short_description")?.trim()||null,m=a.get("long_description")?.trim()||null,n=a.get("category")?.trim()||null,o=a.get("inventory_item_id")?.trim()||null;if(!o)throw Error("Select an inventory item to link.");let p=a.get("unit_cost")?.trim()??"",q=0===p.length?null:Math.max(0,Math.round(100*(Number.parseFloat(p)||0))),r=(a.get("currency")?.trim()||"CAD").toUpperCase(),s=Math.max(1,parseInt(String(a.get("default_quantity")??"1"),10)||1),t={slug:k,title:j,short_description:l,long_description:m,category:n,inventory_item_id:o,unit_cost_cents:q,currency:r,default_quantity:s,priority:Math.max(1,parseInt(String(a.get("priority")??"100"),10)||100),target_buffer:a.get("target_buffer")&&parseInt(String(a.get("target_buffer")),10)||null,image_url:a.get("image_url")?.trim()||null,stripe_price_id:a.get("stripe_price_id")?.trim()||null,is_active:"on"===a.get("is_active")},u=i?d.from("catalog_items").update(t).eq("id",i):d.from("catalog_items").insert(t),{data:v,error:w}=await u.select("id").maybeSingle();if(w)throw w;await (0,f.logAuditEvent)(b,{actorProfileId:e,action:i?"donation_catalog_updated":"donation_catalog_created",entityType:"donation_catalog_item",entityRef:(0,f.buildEntityRef)({schema:"donations",table:"catalog_items",id:v?.id??null}),meta:{pk_uuid:v?.id??null,slug:k,title:j}}),await (0,c.revalidatePath)("/admin/donations")}async function j(a){let{supabase:b,donationsClient:d,actorProfileId:e}=await h(),g=a.get("id")?.trim();if(!g)throw Error("Missing catalogue item id.");let i="activate"===a.get("next_state"),{error:j}=await d.from("catalog_items").update({is_active:i}).eq("id",g);if(j)throw j;await (0,f.logAuditEvent)(b,{actorProfileId:e,action:"donation_catalog_status_changed",entityType:"donation_catalog_item",entityRef:(0,f.buildEntityRef)({schema:"donations",table:"catalog_items",id:g}),meta:{pk_uuid:g,is_active:i}}),await (0,c.revalidatePath)("/admin/donations")}async function k(a){let{supabase:b,donationsClient:d,actorProfileId:e}=await h(),i=a.get("inventory_item_id")?.trim();if(!i)throw Error("Select an inventory item to import.");let{data:j,error:k}=await d.from("catalog_items").select("id").eq("inventory_item_id",i).maybeSingle();if(k)throw k;if(j)throw Error("This inventory item is already in the donation catalogue.");let{data:l,error:m}=await b.schema("inventory").from("v_items_with_balances").select("id, name, category, cost_per_unit, minimum_threshold").eq("id",i).maybeSingle();if(m)throw m;if(!l)throw Error("Inventory item not found.");let n=Number.parseFloat(String(l.cost_per_unit??"0")),o=Number.isFinite(n)?Math.max(0,Math.round(100*n)):null,p=null===l.minimum_threshold||void 0===l.minimum_threshold?null:Number.parseInt(String(l.minimum_threshold),10)||null,q=String(l.name??"Donation item"),r=g(q),s="string"==typeof l.category?l.category:null,{data:t,error:u}=await d.from("catalog_items").insert({inventory_item_id:i,title:q,slug:r,category:s,unit_cost_cents:o,target_buffer:p,default_quantity:1,priority:100,currency:"CAD",is_active:!0}).select("id").maybeSingle();if(u)throw u;await (0,f.logAuditEvent)(b,{actorProfileId:e,action:"donation_catalog_imported",entityType:"donation_catalog_item",entityRef:(0,f.buildEntityRef)({schema:"donations",table:"catalog_items",id:t?.id??null}),meta:{pk_uuid:t?.id??null,inventory_item_id:i,title:q}}),await (0,c.revalidatePath)("/admin/donations")}(0,a.i(13095).ensureServerEntryExports)([i,j,k]),(0,b.registerServerReference)(i,"40214e6b4997db96dd5302cfb356060933420a9515",null),(0,b.registerServerReference)(j,"40836d0e0f78fba5b78cb58dd3cbc2e911d47afc9d",null),(0,b.registerServerReference)(k,"40b71659762c704805d5c983f957dcce2614a2686d",null),a.s(["importInventoryItem",()=>k,"saveCatalogItem",()=>i,"toggleCatalogItem",()=>j])},86324,a=>{"use strict";var b=a.i(86731),c=a.i(49701);a.s([],98241),a.i(98241),a.s(["00b7ee4fee263fec1fe8acb860989f6ddb47485e3a",()=>b.$$RSC_SERVER_ACTION_0,"40214e6b4997db96dd5302cfb356060933420a9515",()=>c.saveCatalogItem,"40836d0e0f78fba5b78cb58dd3cbc2e911d47afc9d",()=>c.toggleCatalogItem,"40b71659762c704805d5c983f957dcce2614a2686d",()=>c.importInventoryItem],86324)}];

//# sourceMappingURL=_af7d2048._.js.map