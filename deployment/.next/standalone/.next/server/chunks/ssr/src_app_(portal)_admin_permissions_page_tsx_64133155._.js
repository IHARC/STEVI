module.exports=[61470,28765,a=>{"use strict";var b=a.i(7997),c=a.i(37936);a.i(70396);var d=a.i(73727),e=a.i(9919),f=a.i(65108),g=a.i(42145),h=a.i(46592),i=a.i(35330),j=a.i(19637),k=a.i(38904),l=a.i(717);a.i(75465);var m=a.i(63770),n=Symbol.for("react.lazy"),o=l[" use ".trim().toString()];function p(a){var b;return null!=a&&"object"==typeof a&&"$$typeof"in a&&a.$$typeof===n&&"_payload"in a&&"object"==typeof(b=a._payload)&&null!==b&&"then"in b}var q=Symbol("radix.slottable");function r(a){return l.isValidElement(a)&&"function"==typeof a.type&&"__radixId"in a.type&&a.type.__radixId===q}var s=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"].reduce((a,c)=>{var d,e;let f,g,h,i=(e=d=`Primitive.${c}`,(f=l.forwardRef((a,b)=>{let{children:c,...d}=a;if(p(c)&&"function"==typeof o&&(c=o(c._payload)),l.isValidElement(c)){var e;let a,f,g=(e=c,(f=(a=Object.getOwnPropertyDescriptor(e.props,"ref")?.get)&&"isReactWarning"in a&&a.isReactWarning)?e.ref:(f=(a=Object.getOwnPropertyDescriptor(e,"ref")?.get)&&"isReactWarning"in a&&a.isReactWarning)?e.props.ref:e.props.ref||e.ref),h=function(a,b){let c={...b};for(let d in b){let e=a[d],f=b[d];/^on[A-Z]/.test(d)?e&&f?c[d]=(...a)=>{let b=f(...a);return e(...a),b}:e&&(c[d]=e):"style"===d?c[d]={...e,...f}:"className"===d&&(c[d]=[e,f].filter(Boolean).join(" "))}return{...a,...c}}(d,c.props);return c.type!==l.Fragment&&(h.ref=b?(0,m.composeRefs)(b,g):g),l.cloneElement(c,h)}return l.Children.count(c)>1?l.Children.only(null):null})).displayName=`${e}.SlotClone`,g=f,(h=l.forwardRef((a,c)=>{let{children:d,...e}=a;p(d)&&"function"==typeof o&&(d=o(d._payload));let f=l.Children.toArray(d),h=f.find(r);if(h){let a=h.props.children,d=f.map(b=>b!==h?b:l.Children.count(a)>1?l.Children.only(null):l.isValidElement(a)?a.props.children:null);return(0,b.jsx)(g,{...e,ref:c,children:l.isValidElement(a)?l.cloneElement(a,void 0,d):null})}return(0,b.jsx)(g,{...e,ref:c,children:d})})).displayName=`${d}.Slot`,h),j=l.forwardRef((a,d)=>{let{asChild:e,...f}=a;return(0,b.jsx)(e?i:c,{...f,ref:d})});return j.displayName=`Primitive.${c}`,{...a,[c]:j}},{}),t="horizontal",u=["horizontal","vertical"],v=l.forwardRef((a,c)=>{var d;let{decorative:e,orientation:f=t,...g}=a,h=(d=f,u.includes(d))?f:t;return(0,b.jsx)(s.div,{"data-orientation":h,...e?{role:"none"}:{"aria-orientation":"vertical"===h?h:void 0,role:"separator"},...g,ref:c})});v.displayName="Separator";var w=a.i(39138);let x=l.forwardRef(({className:a,orientation:c="horizontal",decorative:d=!0,...e},f)=>(0,b.jsx)(v,{ref:f,decorative:d,orientation:c,className:(0,w.cn)("shrink-0 bg-border","horizontal"===c?"h-[1px] w-full":"h-full w-[1px]",a),...e}));x.displayName=v.displayName;var y=a.i(18558),z=a.i(16349),A=a.i(63985),B=a.i(13095);let C="/admin/permissions";function D(a){return a instanceof Error?a.message:"string"==typeof a?a:"Unable to complete that request."}async function E(){let a=await (0,z.createSupabaseServerClient)(),b=await (0,f.loadPortalAccess)(a);if(!b)throw Error("Sign in to continue.");if(!b.isProfileApproved)throw Error("Profile approval required.");if(!(b.portalRoles.includes("portal_admin")||b.iharcRoles.includes("iharc_admin")))throw Error("Elevated admin access is required.");let c=await (0,g.ensurePortalProfile)(a,b.userId);return{supabase:a,actorProfile:c,access:b}}async function F(a){try{let b=a.get("role_id"),c=a.get("permission_id"),d=a.get("enable");if("string"!=typeof b||"string"!=typeof c||"string"!=typeof d)throw Error("Invalid permission request.");let e="true"===d,{supabase:f,actorProfile:g,access:h}=await E();if(e){let{error:a}=await f.schema("core").from("role_permissions").insert({role_id:b,permission_id:c,granted_by:h.userId},{onConflict:"role_id,permission_id"});if(a)throw a}else{let{error:a}=await f.schema("core").from("role_permissions").delete().match({role_id:b,permission_id:c});if(a)throw a}return await (0,A.logAuditEvent)(f,{actorProfileId:g.id,action:e?"admin_permission_granted":"admin_permission_revoked",entityType:"role_permission",entityRef:(0,A.buildEntityRef)({schema:"core",table:"role_permissions",id:`${b}_${c}`}),meta:{roleId:b,permissionId:c}}),(0,y.revalidatePath)(C),{success:!0}}catch(a){return console.error("togglePermissionAction",a),{success:!1,error:D(a)}}}async function G(a){try{let b=a.get("name")?.trim(),c=a.get("description")?.trim()||null,d=a.get("domain")?.trim()||null,e=a.get("category")?.trim()||null;if(!b)throw Error("Name is required.");let{supabase:f,actorProfile:g,access:h}=await E(),{error:i}=await f.schema("core").from("permissions").insert({name:b,description:c,domain:d,category:e,created_by:h.userId,updated_by:h.userId});if(i)throw i;return await (0,A.logAuditEvent)(f,{actorProfileId:g.id,action:"admin_permission_created",entityType:"permission",entityRef:(0,A.buildEntityRef)({schema:"core",table:"permissions",id:b}),meta:{name:b,domain:d,category:e}}),(0,y.revalidatePath)(C),{success:!0}}catch(a){return console.error("createPermissionAction",a),{success:!1,error:D(a)}}}(0,B.ensureServerEntryExports)([F,G]),(0,c.registerServerReference)(F,"40e87b9887494d090f534d57dfa531f3caaca5386b",null),(0,c.registerServerReference)(G,"40dbfdb4347b69cdf097b12653aca1dd74e80eea6f",null),a.s(["createPermissionAction",()=>G,"togglePermissionAction",()=>F],28765);var H=a.i(55583),I=a.i(43562),J=a.i(58774);let K=async function(a){let b=await F(a);if(!b.success)throw Error(b.error)};(0,c.registerServerReference)(K,"40db2a9b2c1420ee643287fed8911c3fa007a7519e",null);let L=async function(a){let b=await G(a);if(!b.success)throw Error(b.error)};async function M(){let a,c=await (0,e.createSupabaseRSCClient)(),l=await (0,f.loadPortalAccess)(c);l||(0,d.redirect)("/login?next=/admin/permissions"),l.isProfileApproved&&(l.portalRoles.includes("portal_admin")||l.iharcRoles.includes("iharc_admin"))||(0,d.redirect)((0,h.resolveDefaultWorkspacePath)(l)),await (0,g.ensurePortalProfile)(c,l.userId);let[m,n,o]=await Promise.all([c.schema("core").from("roles").select("id, name, display_name, description, is_system_role").order("name"),c.schema("core").from("permissions").select("id, name, description, category, domain").order("domain").order("name"),c.schema("core").from("role_permissions").select("role_id, permission_id")]);if(m.error)throw m.error;if(n.error)throw n.error;if(o.error)throw o.error;let p=m.data??[],q=n.data??[],r=new Set((o.data??[]).map(a=>`${a.role_id}:${a.permission_id}`)),s=(a={},q.forEach(b=>{let c=b.domain||"general";a[c]||(a[c]=[]),a[c].push(b)}),Object.values(a).forEach(a=>a.sort((a,b)=>a.name.localeCompare(b.name))),a);return(0,b.jsxs)("div",{className:"page-shell page-stack",children:[(0,b.jsxs)("header",{className:"flex flex-col gap-space-xs",children:[(0,b.jsx)("p",{className:"text-label-sm font-medium uppercase text-muted-foreground",children:"Admin Â· Permissions"}),(0,b.jsx)("h1",{className:"text-title-lg text-on-surface sm:text-headline-sm",children:"Permissions control"}),(0,b.jsx)("p",{className:"max-w-3xl text-body-md text-muted-foreground sm:text-body-lg",children:"Manage granular permissions for roles. Changes take effect immediately and refresh user claims on next refresh."})]}),(0,b.jsxs)("div",{className:"grid gap-space-lg lg:grid-cols-3",children:[(0,b.jsxs)(i.Card,{className:"lg:col-span-2 border-outline/20 bg-surface-container",children:[(0,b.jsxs)(i.CardHeader,{children:[(0,b.jsx)(i.CardTitle,{children:"Roles & permissions"}),(0,b.jsx)(i.CardDescription,{children:"Toggle which permissions are granted to each role."})]}),(0,b.jsx)(i.CardContent,{className:"space-y-space-md",children:p.map(a=>(0,b.jsxs)("div",{className:"rounded-2xl border border-outline/12 p-space-md space-y-space-sm",children:[(0,b.jsx)("div",{className:"flex items-start justify-between gap-space-sm",children:(0,b.jsxs)("div",{children:[(0,b.jsxs)("div",{className:"flex items-center gap-space-xs",children:[(0,b.jsx)("h2",{className:"text-title-md text-on-surface",children:a.display_name||a.name}),a.is_system_role?(0,b.jsx)(j.Badge,{variant:"outline",children:"System"}):null]}),a.description?(0,b.jsx)("p",{className:"text-body-sm text-muted-foreground",children:a.description}):null]})}),(0,b.jsx)(x,{}),(0,b.jsx)("div",{className:"space-y-space-sm",children:Object.entries(s).map(([c,d])=>(0,b.jsxs)("div",{className:"space-y-space-2xs",children:[(0,b.jsx)("p",{className:"text-label-sm font-medium uppercase text-muted-foreground",children:c}),(0,b.jsx)("div",{className:"grid gap-space-xs md:grid-cols-2",children:d.map(c=>{let d=r.has(`${a.id}:${c.id}`);return(0,b.jsxs)("form",{action:K,className:"flex items-start justify-between gap-space-sm rounded-xl border border-outline/10 px-space-sm py-space-2xs",children:[(0,b.jsxs)("div",{className:"space-y-[2px]",children:[(0,b.jsx)("p",{className:"text-body-sm font-medium text-on-surface",children:c.name}),c.description?(0,b.jsx)("p",{className:"text-label-sm text-muted-foreground",children:c.description}):null]}),(0,b.jsx)("input",{type:"hidden",name:"role_id",value:a.id}),(0,b.jsx)("input",{type:"hidden",name:"permission_id",value:c.id}),(0,b.jsx)("input",{type:"hidden",name:"enable",value:(!d).toString()}),(0,b.jsx)(k.Button,{type:"submit",variant:d?"outline":"secondary",size:"sm",children:d?"Revoke":"Grant"})]},c.id)})})]},c))})]},a.id))})]}),(0,b.jsxs)(i.Card,{className:"border-outline/20",children:[(0,b.jsxs)(i.CardHeader,{children:[(0,b.jsx)(i.CardTitle,{children:"Create permission"}),(0,b.jsx)(i.CardDescription,{children:"Add a new granular permission for assignment to roles."})]}),(0,b.jsx)(i.CardContent,{children:(0,b.jsxs)("form",{action:L,className:"space-y-space-sm",children:[(0,b.jsxs)("div",{className:"space-y-space-2xs",children:[(0,b.jsx)(I.Label,{htmlFor:"name",children:"Name"}),(0,b.jsx)(H.Input,{id:"name",name:"name",required:!0,placeholder:"e.g., portal.documents.read"})]}),(0,b.jsxs)("div",{className:"space-y-space-2xs",children:[(0,b.jsx)(I.Label,{htmlFor:"description",children:"Description"}),(0,b.jsx)(J.Textarea,{id:"description",name:"description",placeholder:"What does this permission allow?"})]}),(0,b.jsxs)("div",{className:"space-y-space-2xs",children:[(0,b.jsx)(I.Label,{htmlFor:"domain",children:"Domain"}),(0,b.jsx)(H.Input,{id:"domain",name:"domain",placeholder:"e.g., portal, marketing, inventory"})]}),(0,b.jsxs)("div",{className:"space-y-space-2xs",children:[(0,b.jsx)(I.Label,{htmlFor:"category",children:"Category"}),(0,b.jsx)(H.Input,{id:"category",name:"category",placeholder:"e.g., documents"})]}),(0,b.jsx)(k.Button,{type:"submit",children:"Create permission"})]})})]})]})]})}(0,c.registerServerReference)(L,"40255b86f275a4f4e5931b42a7dee03b78e674beb3",null),a.s(["$$RSC_SERVER_ACTION_0",0,K,"$$RSC_SERVER_ACTION_1",0,L,"default",()=>M,"dynamic",0,"force-dynamic"],61470)}];

//# sourceMappingURL=src_app_%28portal%29_admin_permissions_page_tsx_64133155._.js.map