module.exports=[63985,a=>{"use strict";let b="[redacted]",c=["password","token","secret","authorization","cookie","session","otp","code","sin","ssn","birth","dob","email","phone","contact","address"];function d(a){if(null===a||"object"!=typeof a)return!1;let b=Object.getPrototypeOf(a);return b===Object.prototype||null===b}let e=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,f=/^[0-9]+$/,g=/^[a-z0-9_]+$/i,h=/^[a-zA-Z0-9._:-]+$/;function i(a){if(null==a)return null;let b="number"==typeof a?String(a):a.trim?.()??a;return"string"!=typeof b||0===b.length?null:e.test(b)||f.test(b)?b:b.slice(0,128)}function j(a){let b=i(a);return b&&e.test(b)?b:null}function k(a){if(!a)return null;let{schema:b,table:c,id:d}=a;if(!g.test(b)||!g.test(c))return null;let e=i(d);return e&&h.test(e)?`${b.toLowerCase()}.${c.toLowerCase()}:${e}`:null}async function l(a,{actorProfileId:e=null,action:f,entityType:g,entityRef:h,entityId:i,meta:l}){let m=l&&d(l)?function a(e,f){let g={};return Object.entries(e).forEach(([e,h])=>{let i;if(i=e.toLowerCase(),c.some(a=>i.includes(a))){g[e]=b;return}let j=function c(e,f){if(void 0!==e){if(null===e)return null;if("string"==typeof e)return e.length>1024?`${e.slice(0,1024)}...`:e;if("number"==typeof e||"boolean"==typeof e)return e;if("bigint"==typeof e)return e.toString();if(e instanceof Date)return e.toISOString();if(e instanceof URL)return e.toString();if(e instanceof Error)return{name:e.name,message:e.message};if(Array.isArray(e))return e.map(a=>c(a,f)).filter(a=>void 0!==a);if(e instanceof Set)return Array.from(e).map(a=>c(a,f)).filter(a=>void 0!==a);if(e instanceof Map){let a={};return e.forEach((b,d)=>{let e=c(b,f);void 0!==e&&(a[String(d)]=e)}),a}return"object"==typeof e&&d(e)?f.has(e)?b:(f.add(e),a(e,f)):String(e)}}(h,f);void 0!==j&&(g[e]=j)}),g}(l,new WeakSet):{},n="string"==typeof h?h:k(h),o=j(i);!o&&n&&(o=j(n.split(":").pop()??null));let p=!n||"entity_ref"in m?m:{...m,entity_ref:n},q=j(e),{error:r}=await a.rpc("portal_log_audit_event",{p_action:f,p_entity_type:g,p_entity_id:o,p_meta:p,p_actor_profile_id:q});if(r)throw r}a.s(["buildEntityRef",()=>k,"logAuditEvent",()=>l],63985)},13095,(a,b,c)=>{"use strict";function d(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"ensureServerEntryExports",{enumerable:!0,get:function(){return d}})},44080,a=>{"use strict";var b=a.i(3412);async function c(a,c){let d=await (0,b.getOnboardingStatusForUser)(c,a);if("COMPLETED"!==d.status)throw Error("Finish onboarding before continuing.");return d}a.s(["assertOnboardingComplete",()=>c])},83272,81296,a=>{"use strict";var b=a.i(37936),c=a.i(18558),d=a.i(16349),e=a.i(65108),f=a.i(63985),g=a.i(66799),h=a.i(42085),i=a.i(42145),j=a.i(10508);let k="person_access_grants";async function l(a,b){let c=a.schema("core"),{data:d,error:e}=await c.from(k).select("id, person_id, scope, grantee_user_id, grantee_org_id, granted_at, granted_by, organizations(name)").eq("person_id",b).order("granted_at",{ascending:!1});if(e)throw Error("Unable to load access grants.");return(d??[]).map(a=>({id:a.id,personId:a.person_id,scope:a.scope,granteeUserId:a.grantee_user_id,granteeOrgId:a.grantee_org_id,grantedAt:a.granted_at,grantedBy:a.granted_by,orgName:a.organizations?.name??null}))}async function m(a,{personId:b,scope:c,granteeUserId:d,granteeOrgId:e,actorProfileId:g,actorUserId:h}){if(!(await (0,j.getGrantScopes)(a)).includes(c))throw Error("Invalid scope.");if(!d&&!e)throw Error("Provide a user or organization to grant.");let i=a.schema("core"),{error:l}=await i.from(k).insert({person_id:b,scope:c,grantee_user_id:d,grantee_org_id:e,granted_by:h});if(l)throw Error("Unable to save grant.");await (0,f.logAuditEvent)(a,{actorProfileId:g,action:"person_access_grant_added",entityType:"people",entityRef:(0,f.buildEntityRef)({schema:"core",table:"people",id:b}),meta:{pk_int:b,scope:c,grantee_user_id:d,grantee_org_id:e}})}async function n(a,{grantId:b,actorProfileId:c}){let d=a.schema("core"),{data:e,error:g}=await d.from(k).delete().eq("id",b).select("person_id").maybeSingle();if(g)throw Error("Unable to revoke grant.");await (0,f.logAuditEvent)(a,{actorProfileId:c,action:"person_access_grant_revoked",entityType:"people",entityRef:e?(0,f.buildEntityRef)({schema:"core",table:"people",id:e.person_id}):null,meta:{grant_id:b,person_id:e?.person_id??null}})}a.s(["createPersonGrant",()=>m,"fetchPersonGrants",()=>l,"revokePersonGrant",()=>n],81296);let o="registration_flows";async function p(a,b,c){var d;let e,g,h=a.schema("portal"),j=a.schema("core"),k=a.schema("case_mgmt"),{data:l,error:m}=await h.from(o).select("*").eq("id",b).eq("flow_type","client_intake").maybeSingle();if(m)throw Error("Unable to load intake submission.");if(!l)throw Error("That intake no longer exists.");if("submitted"!==l.status)throw Error("This intake has already been processed.");let n=await (0,i.ensurePortalProfile)(a,c),p={first_name:l.chosen_name??"Client",last_name:null,email:l.contact_email,phone:l.contact_phone,data_sharing_consent:l.consent_data_sharing??null,preferred_contact_method:(d=l,(g="string"==typeof(e=d.metadata?.contact_choice)?e:null)&&("email"===g||"phone"===g||"both"===g||"none"===g)?g:null),created_by:l.supabase_user_id??c,person_category:null,person_type:null,status:"active"},{data:r,error:s}=await j.from("people").insert(p).select("*").single();if(s)throw Error("Could not create a person record for this intake.");l.supabase_user_id&&await j.from("user_people").upsert({user_id:l.supabase_user_id,profile_id:l.profile_id??null,person_id:r.id},{onConflict:"user_id"}).throwOnError();let t={person_id:r.id,case_manager_name:n.display_name,case_manager_contact:l.contact_email,case_number:null,case_type:"intake",start_date:new Date().toISOString(),created_by:c},{data:u,error:v}=await k.from("case_management").insert(t).select("*").single();if(v)throw Error("Could not open a case for this intake.");await q({supabase:a,personId:r.id,clientUserId:l.supabase_user_id,actorProfileId:n.id,actorUserId:c,actorOrgId:n.organization_id}),await j.from("people_activities").insert({person_id:r.id,activity_type:"intake",activity_date:new Date().toISOString().slice(0,10),activity_time:new Date().toISOString().slice(11,19),title:"Intake processed",description:"Client intake converted to case. Consents captured.",staff_member:n.display_name,metadata:{intake_id:l.id,consent_contact:l.consent_contact,consent_data_sharing:l.consent_data_sharing,client_visible:!1},created_by:c,provider_profile_id:n.id,provider_org_id:n.organization_id}).throwOnError();let{error:w}=await h.from(o).update({status:"processed",updated_by_user_id:c,profile_id:l.profile_id}).eq("id",l.id);if(w)throw Error("Case created, but failed to mark intake as processed.");return await (0,f.logAuditEvent)(a,{actorProfileId:n.id,action:"intake_processed",entityType:"registration_flow",entityRef:(0,f.buildEntityRef)({schema:"portal",table:o,id:l.id}),meta:{pk_uuid:l.id,person_id:r.id,case_id:u.id}}),{personId:r.id,caseId:u.id}}async function q({supabase:a,personId:b,clientUserId:c,actorProfileId:d,actorUserId:e,actorOrgId:f}){c&&(await m(a,{personId:b,scope:"timeline_client",granteeUserId:c,granteeOrgId:null,actorProfileId:d,actorUserId:e}),await m(a,{personId:b,scope:"view",granteeUserId:c,granteeOrgId:null,actorProfileId:d,actorUserId:e})),null!==f&&(await m(a,{personId:b,scope:"timeline_full",granteeUserId:null,granteeOrgId:f,actorProfileId:d,actorUserId:e}),await m(a,{personId:b,scope:"write_notes",granteeUserId:null,granteeOrgId:f,actorProfileId:d,actorUserId:e}))}var r=a.i(44080),s=a.i(13095);let t="people_activities",u="people";async function v(a){let b=parseInt(String(a.get("case_id")??""),10),g=a.get("message")?.trim()??"";if(!b||Number.isNaN(b))throw Error("Invalid case.");if(!g||g.length<8)throw Error("Please share a brief update (at least 8 characters).");let i=await (0,d.createSupabaseServerClient)(),j=await (0,e.loadPortalAccess)(i);if(!j)throw Error("Sign in to send an update.");await (0,r.assertOnboardingComplete)(i,j.userId);let k=await (0,h.fetchClientCaseDetail)(i,j.userId,b);if(!k)throw Error("Case not found.");let l=i.schema("core"),m=new Date,n=m.toISOString().slice(0,10),o=m.toISOString().slice(11,19),{error:p}=await l.from(t).insert({person_id:k.personId,activity_type:"client_update",activity_date:n,activity_time:o,title:"Client update",description:g,staff_member:j.profile.display_name,metadata:{client_visible:!0,submitted_via:"portal"},created_by:j.userId,provider_profile_id:j.profile.id,provider_org_id:j.organizationId});if(p)throw Error("Could not record your update.");await (0,f.logAuditEvent)(i,{actorProfileId:j.profile.id,action:"client_update_submitted",entityType:"case_management",entityRef:null,meta:{case_id:b,person_id:k.personId}}),(0,c.revalidatePath)(`/cases/${b}`)}async function w(a){let b="on"===a.get("data_sharing"),h=a.get("preferred_contact")?.trim()||null,i=a.get("privacy_restrictions")?.trim()||null,j=await (0,d.createSupabaseServerClient)(),k=await (0,e.loadPortalAccess)(j);if(!k)throw Error("Sign in to update consents.");await (0,r.assertOnboardingComplete)(j,k.userId);let l=await (0,g.requirePersonForUser)(j,k.userId),m=j.schema("core"),{error:n}=await m.from(u).update({data_sharing_consent:b,preferred_contact_method:h,privacy_restrictions:i,updated_by:k.userId,updated_at:new Date().toISOString()}).eq("id",l.id);if(n)throw Error("Could not save your consent changes.");await (0,f.logAuditEvent)(j,{actorProfileId:k.profile.id,action:"consent_updated",entityType:"people",entityRef:(0,f.buildEntityRef)({schema:"core",table:"people",id:l.id}),meta:{pk_int:l.id,data_sharing_consent:b,preferred_contact_method:h}}),(0,c.revalidatePath)("/profile/consents")}async function x(a){let b=Number.parseInt(String(a.get("person_id")??""),10),g="on"===a.get("data_sharing"),h=a.get("preferred_contact")?.trim()||null,i=a.get("privacy_restrictions")?.trim()||null;if(!b||Number.isNaN(b))throw Error("Invalid person id.");let j=await (0,d.createSupabaseServerClient)(),k=await (0,e.loadPortalAccess)(j);if(!k||!k.canManageConsents)throw Error("You do not have permission to override consents.");let l=j.schema("core"),{error:m}=await l.from(u).update({data_sharing_consent:g,preferred_contact_method:h,privacy_restrictions:i,updated_by:k.userId,updated_at:new Date().toISOString()}).eq("id",b);if(m)throw Error("Unable to update consent.");await (0,f.logAuditEvent)(j,{actorProfileId:k.profile.id,action:"consent_overridden",entityType:"people",entityRef:(0,f.buildEntityRef)({schema:"core",table:"people",id:b}),meta:{pk_int:b,data_sharing_consent:g,preferred_contact_method:h}}),(0,c.revalidatePath)("/admin/consents")}async function y(a){let b=Number.parseInt(String(a.get("person_id")??""),10),f=a.get("scope")?.trim()??"",g=a.get("grantee_user_id")?.trim()||null,h=a.get("grantee_org_id")?.trim()||null,i=h?Number.parseInt(h,10):null;if(!b||Number.isNaN(b))throw Error("Invalid person id.");if(!g&&!i)throw Error("Select a user or organization.");let k=await (0,d.createSupabaseServerClient)(),l=await (0,e.loadPortalAccess)(k);if(!l||!l.canManageConsents)throw Error("You do not have permission to manage grants.");if(!(await (0,j.getGrantScopes)(k)).includes(f))throw Error("Invalid scope.");await m(k,{personId:b,scope:f,granteeUserId:g,granteeOrgId:i,actorProfileId:l.profile.id,actorUserId:l.userId}),(0,c.revalidatePath)("/admin/consents")}async function z(a){let b=a.get("grant_id")?.trim();if(!b)throw Error("Missing grant id.");let f=await (0,d.createSupabaseServerClient)(),g=await (0,e.loadPortalAccess)(f);if(!g||!g.canManageConsents)throw Error("You do not have permission to manage grants.");await n(f,{grantId:b,actorProfileId:g.profile.id}),(0,c.revalidatePath)("/admin/consents")}async function A(a){let b=parseInt(String(a.get("case_id")??""),10),g=a.get("title")?.trim()??"",i=a.get("description")?.trim()??"";if(!b||Number.isNaN(b))throw Error("Invalid case id.");if(!g)throw Error("Add a title for this note.");let j=await (0,d.createSupabaseServerClient)(),k=await (0,e.loadPortalAccess)(j);if(!k||!k.canAccessStaffWorkspace)throw Error("You do not have permission to add notes.");let l=await (0,h.fetchStaffCaseDetail)(j,b);if(!l)throw Error("Case not found.");let m=j.schema("core"),n=new Date,o=n.toISOString().slice(0,10),p=n.toISOString().slice(11,19),{error:q}=await m.from(t).insert({person_id:l.personId,activity_type:"note",activity_date:o,activity_time:p,title:g,description:i||null,staff_member:k.profile.display_name,metadata:{client_visible:!1},created_by:k.userId,provider_profile_id:k.profile.id,provider_org_id:k.organizationId});if(q)throw Error("Unable to add note.");await (0,f.logAuditEvent)(j,{actorProfileId:k.profile.id,action:"case_note_added",entityType:"case_management",entityRef:null,meta:{case_id:b,person_id:l.personId}}),(0,c.revalidatePath)(`/staff/cases/${b}`)}async function B(a){let b=a.get("intake_id")?.trim();if(!b)throw Error("Missing intake id.");let f=await (0,d.createSupabaseServerClient)(),g=await (0,e.loadPortalAccess)(f);if(!g||!g.canAccessStaffWorkspace)throw Error("You do not have permission to process intakes.");await p(f,b,g.userId),(0,c.revalidatePath)("/staff/intake"),(0,c.revalidatePath)("/staff/cases")}(0,s.ensureServerEntryExports)([v,w,x,y,z,A,B]),(0,b.registerServerReference)(v,"40dd84026ffe3371588b963c7e21a5e5cd9cb9f925",null),(0,b.registerServerReference)(w,"40b98ab7bee777c9a2e429c3b76ffa4af3734507d3",null),(0,b.registerServerReference)(x,"403d512cf57f54707ce22e096619b00785c9a08a13",null),(0,b.registerServerReference)(y,"405b56783a84a620326e4832fb567e015f417371ce",null),(0,b.registerServerReference)(z,"40d69b99579f1950c2809c738364aeb0dccc74314b",null),(0,b.registerServerReference)(A,"40b47fe15401f6675cf7642f1c198aeecabaf7e7cc",null),(0,b.registerServerReference)(B,"40d412f480d4bee622cfb3a6fb5caa0db200f7b03e",null),a.s(["adminCreateGrantAction",()=>y,"adminOverrideConsentAction",()=>x,"adminRevokeGrantAction",()=>z,"processIntakeAction",()=>B,"staffAddCaseNoteAction",()=>A,"submitClientCaseUpdateAction",()=>v,"updateConsentsAction",()=>w],83272)}];

//# sourceMappingURL=_8adfebbe._.js.map