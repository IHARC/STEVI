module.exports=[39251,a=>{"use strict";var b=a.i(10508);let c=["agency_partner","government_partner"];async function d(a){let[c,d,e]=await Promise.all([(0,b.getAffiliationTypes)(a),(0,b.getAffiliationStatuses)(a),(0,b.getGovernmentRoleTypes)(a)]);return{affiliationTypes:c,affiliationStatuses:d,governmentRoleTypes:e}}async function e(a,b){if(0===b.length)return new Set;let{data:c,error:d}=await a.schema("core").from("user_roles").select("user_id, roles:roles!inner(name)").in("roles.name",b).not("user_id","is",null);if(d)throw d;let e=new Set;return(c??[]).forEach(a=>{a.user_id&&e.add(a.user_id)}),e}async function f(a,c,d){let f=[];if("staff"===c){let c=await (0,b.getIharcRoles)(a);f.push(...c)}return(d&&f.push(d),0===f.length)?null:e(a,f)}async function g(a,b){let c=new Map;if(0===b.length)return c;let{data:d,error:e}=await a.schema("core").from("user_roles").select("user_id, roles:roles!inner(name)").in("user_id",b);if(e)throw e;return(d??[]).forEach(a=>{let b=a.user_id,d=a.roles?.name;if(!d)return;let e=c.get(b)??{portal:[],iharc:[]};d.startsWith("portal_")?e.portal.push(d):d.startsWith("iharc_")&&e.iharc.push(d),c.set(b,e)}),c}async function h(a,b){let c=new Map;if(0===b.length)return c;let{data:d,error:e}=await a.schema("core").from("organizations").select("id, name, status").in("id",b);if(e)throw e;return(d??[]).forEach(a=>{c.set(a.id,{id:a.id,name:a.name,status:a.status})}),c}async function i(a,b){let c=new Map;return 0===b.length||await Promise.all(b.map(async b=>{try{let{data:d,error:e}=await a.rpc("portal_get_user_email",{p_profile_id:b.id});!e&&d&&c.set(b.id,d)}catch(a){}})),c}async function j(a,b,d={}){let e=function(a,b=1){if("string"==typeof a){let b=Number.parseInt(a,10);if(Number.isFinite(b)&&b>0)return b}return"number"==typeof a&&Number.isFinite(a)&&a>0?a:b}(d.page),k=function(a,b=25){if("string"==typeof a){let b=Number.parseInt(a,10);if(Number.isFinite(b)&&b>0)return Math.min(b,100)}return"number"==typeof a&&Number.isFinite(a)&&a>0?Math.min(a,100):b}(d.pageSize),l=(e-1)*k,m=function(a){if(!a)return null;let b=a.trim();return b?b.replace(/[%_]/g,a=>`\\${a}`):null}(d.search??null),n=d.role??null,o=await f(a,b,n);if(o&&0===o.size)return{items:[],page:e,pageSize:k,total:0,hasMore:!1};let p=a.schema("portal").from("profiles").select("id, user_id, display_name, position_title, affiliation_type, affiliation_status, organization_id, last_seen_at, updated_at",{count:"exact"});"clients"===b?p=p.eq("affiliation_type","community_member"):"partners"===b&&(p=p.in("affiliation_type",c)),d.status&&(p=p.eq("affiliation_status",d.status)),d.organizationId&&(p=p.eq("organization_id",d.organizationId)),o&&(p=p.in("user_id",Array.from(o))),m&&(p=p.ilike("display_name",`%${m}%`));let q="name"===d.sort?"display_name":"updated_at";p=p.order(q,{ascending:"name"===d.sort}).range(l,l+k-1);let{data:r,error:s,count:t}=await p;if(s)throw s;let u=r??[];if(0===u.length)return{items:[],page:e,pageSize:k,total:t??0,hasMore:!1};let v=Array.from(new Set(u.map(a=>a.organization_id).filter(a=>"number"==typeof a))),w=Array.from(new Set(u.map(a=>a.user_id).filter(a=>"string"==typeof a&&a.length>0))),[x,y,z]=await Promise.all([h(a,v),g(a,w),i(a,u)]),A=u.map(a=>{let b=y.get(a.user_id??"")??{portal:[],iharc:[]},c=a.organization_id?x.get(a.organization_id):null;return{profileId:a.id,displayName:a.display_name,positionTitle:a.position_title,affiliationType:a.affiliation_type,affiliationStatus:a.affiliation_status,organizationId:a.organization_id,organizationName:c?.name??null,userId:a.user_id,email:z.get(a.id)??null,lastSeenAt:a.last_seen_at,roles:b}}),B=t??A.length,C=B>l+A.length;return{items:A,total:B,page:e,pageSize:k,hasMore:C}}async function k(a){let d=a.schema("portal"),f=(0,b.getIharcRoles)(a),[g,h,i,j,k,l]=await Promise.all([d.from("profiles").select("id",{count:"exact",head:!0}),d.from("profiles").select("id",{count:"exact",head:!0}).eq("affiliation_type","community_member"),d.from("profiles").select("id",{count:"exact",head:!0}).in("affiliation_type",c),d.from("profiles").select("id",{count:"exact",head:!0}).eq("affiliation_status","pending"),d.from("profiles").select("id",{count:"exact",head:!0}).eq("affiliation_status","revoked"),f.then(b=>e(a,b))]);return{total:g.count??0,clients:h.count??0,partners:i.count??0,pending:j.count??0,revoked:k.count??0,staff:l.size}}async function l(a,b){let c=a.schema("portal"),{data:d,error:e}=await c.from("profiles").select("*").eq("id",b).maybeSingle();if(e)throw e;if(!d)return null;let f=d.organization_id?await (async()=>{let{data:b,error:c}=await a.schema("core").from("organizations").select("id, name, status").eq("id",d.organization_id).maybeSingle();if(c)throw c;return b??null})():null,h=d.user_id,j=h?await g(a,[h]):new Map,k=h?j.get(h)??{portal:[],iharc:[]}:{portal:[],iharc:[]},l=(await i(a,[d])).get(d.id)??null,{data:m,error:n}=await c.from("audit_log").select("id, action, created_at, actor_profile_id, entity_id, entity_type, meta").eq("entity_id",b).order("created_at",{ascending:!1}).limit(30);if(n)throw n;let o=(m??[]).map(a=>({id:a.id,action:a.action,createdAt:a.created_at,actorProfileId:a.actor_profile_id,meta:a.meta}))??[];return{profile:d,organization:f?{id:f.id,name:f.name,status:f.status}:null,roles:k,email:l,auditEvents:o}}function m(a){if("string"!=typeof a)return null;let b=a.trim();if(!b)return null;let c=Number.parseInt(b,10);return Number.isNaN(c)?null:c}function n(a,b){return a&&b.affiliationTypes.includes(a)?a:null}function o(a,b){return a&&b.affiliationStatuses.includes(a)?a:null}function p(a,b){return a&&b.governmentRoleTypes.includes(a)?a:null}function q(a){return"clients"===a||"partners"===a||"staff"===a?a:"all"}function r(a){if(!a)return 1;let b=Number.parseInt(Array.isArray(a)?a[0]:a,10);return Number.isFinite(b)&&b>0?b:1}a.s(["coerceSegment",()=>q,"fetchAdminUserDetail",()=>l,"fetchAdminUserSummary",()=>k,"fetchAdminUsers",()=>j,"loadProfileEnums",()=>d,"normalizeOrganizationId",()=>m,"parseAffiliationStatus",()=>o,"parseAffiliationType",()=>n,"parseGovernmentRole",()=>p,"parsePageParam",()=>r])},42457,a=>{"use strict";var b=a.i(37936),c=a.i(18558),d=a.i(16349),e=a.i(42145),f=a.i(65108),g=a.i(63985),h=a.i(39251),i=a.i(10508),j=a.i(13095);let k="/admin/users",l=["/admin/users/all","/admin/users/clients","/admin/users/partners","/admin/users/staff"],m=new Set(["Sign in to continue.","Admin access is required.","Elevated admin access is required.","Profile approval required.","Profile context is missing.","Profile context is required.","Invalid role request.","Unsupported role change request.","Provide a valid email.","Profile not found."]);function n(a){let b="string"==typeof a?a:a instanceof Error?a.message:"";return b&&m.has(b)?b:"Unable to complete that request right now. Please try again or contact support."}async function o(a){let b=new Set([k,...l]);a&&b.add(`${k}/profile/${a}`),await Promise.all(Array.from(b).map(a=>(0,c.revalidatePath)(a)))}async function p(a){let[b,c]=await Promise.all([(0,i.getPortalRoles)(a),(0,i.getIharcRoles)(a)]);return new Set([...b,...c])}function q(a){return!!a&&(a.portalRoles.includes("portal_admin")||a.iharcRoles.includes("iharc_admin"))}function r(a){return!!a&&a.portalRoles.includes("portal_org_admin")}async function s({requireElevated:a=!1,allowOrgAdmin:b=!1}={}){let c=await (0,d.createSupabaseServerClient)(),g=await (0,f.loadPortalAccess)(c);if(!g)throw Error("Sign in to continue.");if(!g.isProfileApproved)throw Error("Profile approval required.");if(!g.canAccessAdminWorkspace)throw Error("Admin access is required.");if(a&&!q(g))throw Error("Elevated admin access is required.");if(!a&&b&&!(q(g)||r(g)))throw Error("Admin access is required.");let h=await (0,e.ensurePortalProfile)(c,g.userId);return{supabase:c,actorProfile:h,access:g}}async function t(a,b){if(b)try{await a.rpc("refresh_user_permissions",{user_uuid:b})}catch(a){console.warn("refresh_user_permissions failed",a)}}async function u(a){try{let b=a.get("profile_id");if("string"!=typeof b||!b)throw Error("Profile context is missing.");let{supabase:c,actorProfile:d,access:e}=await s({allowOrgAdmin:!0}),f=await (0,h.loadProfileEnums)(c),i=a.get("display_name"),j=a.get("position_title"),k=(0,h.parseAffiliationType)(a.get("affiliation_type"),f),l=(0,h.parseAffiliationStatus)(a.get("affiliation_status"),f),m=(0,h.normalizeOrganizationId)(a.get("organization_id")),n=(0,h.parseGovernmentRole)(a.get("government_role_type"),f),p=c.schema("portal"),u={};"string"==typeof i&&(u.display_name=i.trim()),"string"==typeof j&&(u.position_title=j.trim()||null),k&&(u.affiliation_type=k),l&&(u.affiliation_status=l),u.organization_id=m,u.government_role_type=n;let{data:v,error:w}=await p.from("profiles").select("user_id, organization_id").eq("id",b).maybeSingle();if(w)throw w;let x=q(e);if(r(e)&&!x){if(!d.organization_id||v?.organization_id!==d.organization_id)throw Error("Elevated admin access is required.")}else if(!x)throw Error("Elevated admin access is required.");let{error:y}=await p.from("profiles").update(u).eq("id",b);if(y)throw y;return await t(c,v?.user_id??null),await (0,g.logAuditEvent)(c,{actorProfileId:d.id,action:"admin_user_updated",entityType:"profile",entityRef:(0,g.buildEntityRef)({schema:"portal",table:"profiles",id:b}),meta:u}),await o(b),{success:!0}}catch(a){return console.error("updateProfileAction error",a),{success:!1,error:n(a)}}}async function v(a){try{let b=a.get("profile_id"),c=a.get("role_name"),d=a.get("enable");if("string"!=typeof b||"string"!=typeof c||"string"!=typeof d)throw Error("Invalid role request.");let e="true"===d,{supabase:f,actorProfile:h,access:i}=await s({allowOrgAdmin:!0}),j=await p(f),k=f.schema("portal"),{data:l,error:m}=await k.from("profiles").select("user_id, organization_id").eq("id",b).maybeSingle();if(m||!l)throw m??Error("Profile not found.");if(!j.has(c))throw Error("Unsupported role change request.");let n=q(i),u=r(i);if(!n){if(!u||!h.organization_id||h.organization_id!==l.organization_id||!new Set(["portal_org_admin","portal_org_rep","portal_user"]).has(c))throw Error("Elevated admin access is required.");if(l.user_id){let{data:a,error:b}=await f.schema("core").from("user_roles").select("roles:roles!inner(name)").eq("user_id",l.user_id);if(b)throw b;let c=new Set((a??[]).map(a=>a.roles?.name));if(c.has("portal_admin")||c.has("iharc_admin"))throw Error("Elevated admin access is required.")}}let{error:v}=await k.rpc("set_profile_role",{p_profile_id:b,p_role_name:c,p_enable:e});if(v)throw v;return await t(f,l.user_id),await (0,g.logAuditEvent)(f,{actorProfileId:h.id,action:e?"admin_role_granted":"admin_role_revoked",entityType:"profile",entityRef:(0,g.buildEntityRef)({schema:"portal",table:"profiles",id:b}),meta:{role:c}}),await o(b),{success:!0}}catch(a){return console.error("toggleRoleAction error",a),{success:!1,error:n(a)}}}async function w(a){try{let b=a.get("profile_id");if("string"!=typeof b||!b)throw Error("Profile context is required.");let{supabase:c,actorProfile:d,access:e}=await s({allowOrgAdmin:!0}),f=c.schema("portal"),{data:h,error:i}=await f.from("profiles").select("user_id, organization_id").eq("id",b).maybeSingle();if(i||!h)throw i??Error("Profile not found.");let j=q(e),k=r(e);if(!j){if(!k||!d.organization_id||d.organization_id!==h.organization_id)throw Error("Elevated admin access is required.");if(h.user_id){let{data:a,error:b}=await c.schema("core").from("user_roles").select("roles:roles!inner(name)").eq("user_id",h.user_id);if(b)throw b;let d=new Set((a??[]).map(a=>a.roles?.name));if(d.has("portal_admin")||d.has("iharc_admin"))throw Error("Elevated admin access is required.")}}let l=new Date().toISOString(),{error:m}=await f.from("profiles").update({affiliation_status:"revoked",organization_id:null,government_role_type:null,updated_at:l}).eq("id",b);if(m)throw m;for(let a of["portal_org_admin","portal_org_rep"])try{await f.rpc("set_profile_role",{p_profile_id:b,p_role_name:a,p_enable:!1})}catch(b){console.warn(`Failed to revoke ${a} during archive`,b)}return await t(c,h.user_id),await (0,g.logAuditEvent)(c,{actorProfileId:d.id,action:"admin_user_archived",entityType:"profile",entityRef:(0,g.buildEntityRef)({schema:"portal",table:"profiles",id:b})}),await o(b),{success:!0}}catch(a){return console.error("archiveUserAction error",a),{success:!1,error:n(a)}}}async function x(a){try{let b=a.get("invite_email");if("string"!=typeof b||!b.includes("@"))throw Error("Provide a valid email.");let{supabase:c,actorProfile:d,access:e}=await s({allowOrgAdmin:!0}),f=await (0,h.loadProfileEnums)(c),i=a.get("invite_display_name")??null,j=a.get("invite_position_title")??null,k=(0,h.parseAffiliationType)(a.get("invite_affiliation_type"),f)??"community_member",l=(0,h.normalizeOrganizationId)(a.get("invite_organization_id")),m=a.get("invite_message")??null,{data:n,error:p}=await c.auth.getSession();if(p||!n.session?.access_token)throw p??Error("Missing session token. Refresh and try again.");let t=q(e),u=r(e);if(!t&&(!u||!d.organization_id||d.organization_id!==l))throw Error("Elevated admin access is required.");let v=await c.functions.invoke("portal-admin-invite",{body:{email:b,displayName:i,positionTitle:j,affiliationType:k,organizationId:l,message:m,actorProfileId:d.id},headers:{Authorization:`Bearer ${n.session.access_token}`}});if(v.error)throw Error(v.error.message||"Failed to send invite.");return await (0,g.logAuditEvent)(c,{actorProfileId:d.id,action:"admin_invite_sent",entityType:"profile_invite",entityRef:(0,g.buildEntityRef)({schema:"portal",table:"profile_invites",id:b}),meta:{email:b,affiliationType:k,organizationId:l}}),await o(),{success:!0}}catch(a){return console.error("sendInviteAction error",a),{success:!1,error:n(a)}}}(0,j.ensureServerEntryExports)([u,v,w,x]),(0,b.registerServerReference)(u,"403ff0050b2e2d02d65bd8bee793dd4af4f3fa9288",null),(0,b.registerServerReference)(v,"40e1e9d33210be144f9fc3d75f3dc268aad536e59d",null),(0,b.registerServerReference)(w,"40d419e7ff0d372899577dde67ea274d4065629bff",null),(0,b.registerServerReference)(x,"407df7d97dcfef1c2b659533a111f5e02d6cc1fab6",null),a.s(["archiveUserAction",()=>w,"sendInviteAction",()=>x,"toggleRoleAction",()=>v,"updateProfileAction",()=>u])}];

//# sourceMappingURL=src_5235104d._.js.map