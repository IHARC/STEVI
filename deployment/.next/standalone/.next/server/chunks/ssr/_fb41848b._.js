module.exports=[63985,a=>{"use strict";let b="[redacted]",c=["password","token","secret","authorization","cookie","session","otp","code","sin","ssn","birth","dob","email","phone","contact","address"];function d(a){if(null===a||"object"!=typeof a)return!1;let b=Object.getPrototypeOf(a);return b===Object.prototype||null===b}let e=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,f=/^[0-9]+$/,g=/^[a-z0-9_]+$/i,h=/^[a-zA-Z0-9._:-]+$/;function i(a){if(null==a)return null;let b="number"==typeof a?String(a):a.trim?.()??a;return"string"!=typeof b||0===b.length?null:e.test(b)||f.test(b)?b:b.slice(0,128)}function j(a){let b=i(a);return b&&e.test(b)?b:null}function k(a){if(!a)return null;let{schema:b,table:c,id:d}=a;if(!g.test(b)||!g.test(c))return null;let e=i(d);return e&&h.test(e)?`${b.toLowerCase()}.${c.toLowerCase()}:${e}`:null}async function l(a,{actorProfileId:e=null,action:f,entityType:g,entityRef:h,entityId:i,meta:l}){let m=l&&d(l)?function a(e,f){let g={};return Object.entries(e).forEach(([e,h])=>{let i;if(i=e.toLowerCase(),c.some(a=>i.includes(a))){g[e]=b;return}let j=function c(e,f){if(void 0!==e){if(null===e)return null;if("string"==typeof e)return e.length>1024?`${e.slice(0,1024)}...`:e;if("number"==typeof e||"boolean"==typeof e)return e;if("bigint"==typeof e)return e.toString();if(e instanceof Date)return e.toISOString();if(e instanceof URL)return e.toString();if(e instanceof Error)return{name:e.name,message:e.message};if(Array.isArray(e))return e.map(a=>c(a,f)).filter(a=>void 0!==a);if(e instanceof Set)return Array.from(e).map(a=>c(a,f)).filter(a=>void 0!==a);if(e instanceof Map){let a={};return e.forEach((b,d)=>{let e=c(b,f);void 0!==e&&(a[String(d)]=e)}),a}return"object"==typeof e&&d(e)?f.has(e)?b:(f.add(e),a(e,f)):String(e)}}(h,f);void 0!==j&&(g[e]=j)}),g}(l,new WeakSet):{},n="string"==typeof h?h:k(h),o=j(i);!o&&n&&(o=j(n.split(":").pop()??null));let p=!n||"entity_ref"in m?m:{...m,entity_ref:n},q=j(e),{error:r}=await a.rpc("portal_log_audit_event",{p_action:f,p_entity_type:g,p_entity_id:o,p_meta:p,p_actor_profile_id:q});if(r)throw r}a.s(["buildEntityRef",()=>k,"logAuditEvent",()=>l],63985)},13095,(a,b,c)=>{"use strict";function d(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"ensureServerEntryExports",{enumerable:!0,get:function(){return d}})},44080,a=>{"use strict";var b=a.i(3412);async function c(a,c){let d=await (0,b.getOnboardingStatusForUser)(c,a);if("COMPLETED"!==d.status)throw Error("Finish onboarding before continuing.");return d}a.s(["assertOnboardingComplete",()=>c])},30475,a=>{"use strict";var b=a.i(37936),c=a.i(18558),d=a.i(16349),e=a.i(42145),f=a.i(65108),g=a.i(63985),h=a.i(44080),i=a.i(13095);function j(a,b){let c=a.get(b);if("string"!=typeof c)return null;let d=c.trim();return d.length?d:null}function k(a){if(!a)return null;let b=new Date(a);if(Number.isNaN(b.getTime()))throw Error("Provide a valid date and time.");return b.toISOString()}function l(a,b){if(!a)return b;let c=Number.parseInt(a,10);return Number.isNaN(c)||c<=0?b:c}function m(a){return a&&["in_person","phone","video","field","other"].includes(a)?a:"in_person"}let n=new Set(["http:","https:","tel:","mailto:"]);function o(a){if(!a)return null;let b=a.trim();if(!b)return null;try{let a=new URL(b);return n.has(a.protocol)?a.toString():null}catch{return null}}async function p(a,b){let{data:c,error:d}=await a.schema("portal").from("appointments").select("id, client_profile_id, organization_id, staff_profile_id").eq("id",b).maybeSingle();if(d||!c)throw Error("Appointment not found or unavailable.");return c}function q(a,b,c){if(b?.iharcRoles.includes("iharc_admin"))return;let d=null!==a.organization_id&&a.organization_id===b.organizationId;if("client"===c){if(a.client_profile_id===b.profile.id)return;throw Error("You do not have permission to modify this appointment.")}let e=a.staff_profile_id===b.profile.id,f=b.canAccessOrgWorkspace&&d,g=b.canAccessStaffWorkspace&&(d||e),h=b.canAccessAdminWorkspace&&d;if(!g&&!f&&!h)throw Error("You do not have permission to modify this appointment.")}async function r(){(0,c.revalidatePath)("/appointments"),(0,c.revalidatePath)("/home"),(0,c.revalidatePath)("/staff/appointments"),(0,c.revalidatePath)("/org/appointments"),(0,c.revalidatePath)("/admin/appointments")}async function s(a,b){try{let a=j(b,"reason"),c=j(b,"preferred_date"),f=j(b,"staff_preference"),i=m(j(b,"location_type")),k=o(j(b,"meeting_url"));if(!a||a.length<6)return{status:"error",message:"Share a short note (at least 6 characters)."};let l=await (0,d.createSupabaseServerClient)(),{data:{user:n}}=await l.auth.getUser();if(!n)return{status:"error",message:"Sign in before requesting an appointment."};let p=await (0,e.ensurePortalProfile)(l,n.id);try{await (0,h.assertOnboardingComplete)(l,n.id)}catch(a){return{status:"error",message:a instanceof Error?a.message:"Finish onboarding before requesting appointments."}}let{data:q,error:s}=await l.schema("portal").from("appointments").insert({title:a,description:f?`Preferred staff: ${f}`:null,status:"requested",requested_window:c,location_type:i,meeting_url:k,client_profile_id:p.id,requester_profile_id:p.id,organization_id:p.organization_id??null}).select("id").single();if(s||!q)return console.error("requestAppointmentAction failed",s),{status:"error",message:"We could not log the request right now."};return await (0,g.logAuditEvent)(l,{actorProfileId:p.id,action:"appointment_requested",entityType:"appointment",entityRef:(0,g.buildEntityRef)({schema:"portal",table:"appointments",id:q.id}),meta:{requested_window:c,staff_preference:f,location_type:i}}),await r(),{status:"success",message:"Thanks â€” the outreach team will review and confirm a time."}}catch(a){return console.error("requestAppointmentAction error",a),{status:"error",message:"Unable to submit right now. Please try again."}}}async function t(a){try{let b=j(a,"appointment_id"),c=j(a,"cancellation_reason");if(!b)throw Error("Missing appointment id.");let i=await (0,d.createSupabaseServerClient)(),{data:{user:k}}=await i.auth.getUser();if(!k)throw Error("Sign in to cancel an appointment.");let l=await (0,e.ensurePortalProfile)(i,k.id),m=await (0,f.loadPortalAccess)(i);if(!m)throw Error("Sign in to cancel an appointment.");await (0,h.assertOnboardingComplete)(i,k.id);let n=await p(i,b);q(n,{...m,profile:l},"client");let{error:o}=await i.schema("portal").from("appointments").update({status:"cancelled_by_client",canceled_at:new Date().toISOString(),cancellation_reason:c??"Client cancelled via portal"}).eq("id",b).eq("client_profile_id",l.id);if(o)throw o;return await (0,g.logAuditEvent)(i,{actorProfileId:l.id,action:"appointment_cancelled_by_client",entityType:"appointment",entityRef:(0,g.buildEntityRef)({schema:"portal",table:"appointments",id:b}),meta:{cancellation_reason:c}}),await r(),{success:!0}}catch(a){return console.error("cancelAppointmentAsClient error",a),{success:!1,error:"Unable to cancel right now. Please try again."}}}async function u(a){try{let b=j(a,"appointment_id"),c=j(a,"requested_window"),i=m(j(a,"location_type")),k=o(j(a,"meeting_url")),l=j(a,"location");if(!b)throw Error("Missing appointment id.");let n=await (0,d.createSupabaseServerClient)(),{data:{user:s}}=await n.auth.getUser();if(!s)throw Error("Sign in to request a change.");let t=await (0,e.ensurePortalProfile)(n,s.id),u=await (0,f.loadPortalAccess)(n);if(!u)throw Error("Sign in to request a change.");await (0,h.assertOnboardingComplete)(n,s.id);let v=await p(n,b);q(v,{...u,profile:t},"client");let{error:w}=await n.schema("portal").from("appointments").update({status:"reschedule_requested",requested_window:c,reschedule_note:c,location_type:i,meeting_url:k,location:l}).eq("id",b).eq("client_profile_id",t.id);if(w)throw w;return await (0,g.logAuditEvent)(n,{actorProfileId:t.id,action:"appointment_reschedule_requested",entityType:"appointment",entityRef:(0,g.buildEntityRef)({schema:"portal",table:"appointments",id:b}),meta:{requested_window:c}}),await r(),{success:!0}}catch(a){return console.error("requestRescheduleAsClient error",a),{success:!1,error:"Unable to request a change right now."}}}async function v(a){try{let b=j(a,"appointment_id"),c=j(a,"occurs_at"),h=j(a,"duration_minutes"),i=j(a,"location"),n=m(j(a,"location_type")),s=o(j(a,"meeting_url")),t=j(a,"notes"),u=j(a,"staff_profile_id");if(!b)throw Error("Missing appointment id.");let v=k(c);if(!v)throw Error("Add a date and time before confirming.");let w=l(h,60),x=await (0,d.createSupabaseServerClient)(),y=await (0,f.loadPortalAccess)(x);if(!y||!y.canAccessStaffWorkspace&&!y.canAccessOrgWorkspace&&!y.canAccessAdminWorkspace)throw Error("You do not have permission to confirm appointments.");let z=await (0,e.ensurePortalProfile)(x,y.userId),A=await p(x,b);q(A,{...y,profile:z},"staff");let{error:B}=await x.schema("portal").from("appointments").update({status:"scheduled",occurs_at:v,duration_minutes:w,location:i,location_type:n,meeting_url:s,staff_profile_id:u??z.id,confirmed_at:new Date().toISOString(),confirmed_by_profile_id:z.id,reschedule_note:t}).eq("id",b).eq("organization_id",A.organization_id);if(B)throw B;return await (0,g.logAuditEvent)(x,{actorProfileId:z.id,action:"appointment_confirmed",entityType:"appointment",entityRef:(0,g.buildEntityRef)({schema:"portal",table:"appointments",id:b}),meta:{occurs_at:v,duration_minutes:w,location:i,location_type:n}}),await r(),{success:!0}}catch(a){return console.error("confirmAppointment error",a),{success:!1,error:"Unable to confirm right now."}}}async function w(a){try{let b=j(a,"client_profile_id"),c=j(a,"title"),h=k(j(a,"occurs_at")),i=j(a,"location"),n=m(j(a,"location_type")),p=o(j(a,"meeting_url")),q=l(j(a,"duration_minutes"),60),s=j(a,"staff_profile_id");if(!b||!c)throw Error("Client and title are required.");let t=await (0,d.createSupabaseServerClient)(),u=await (0,f.loadPortalAccess)(t);if(!u||!u.canAccessStaffWorkspace&&!u.canAccessOrgWorkspace&&!u.canAccessAdminWorkspace)throw Error("You do not have permission to create appointments.");let v=await (0,e.ensurePortalProfile)(t,u.userId),{error:w,data:x}=await t.schema("portal").from("appointments").insert({title:c,status:h?"scheduled":"pending_confirmation",occurs_at:h,duration_minutes:q,location:i,location_type:n,meeting_url:p,client_profile_id:b,requester_profile_id:v.id,staff_profile_id:s??v.id,organization_id:u.organizationId??null}).select("id").single();if(w||!x)throw w;return await (0,g.logAuditEvent)(t,{actorProfileId:v.id,action:"appointment_created_offline",entityType:"appointment",entityRef:(0,g.buildEntityRef)({schema:"portal",table:"appointments",id:x.id}),meta:{occurs_at:h,client_profile_id:b}}),await r(),{success:!0}}catch(a){return console.error("createOfflineAppointment error",a),{success:!1,error:"Unable to create appointment right now."}}}async function x(a){try{let b=j(a,"appointment_id"),c=j(a,"outcome_notes");if(!b)throw Error("Missing appointment id.");let h=await (0,d.createSupabaseServerClient)(),i=await (0,f.loadPortalAccess)(h);if(!i||!i.canAccessStaffWorkspace&&!i.canAccessAdminWorkspace&&!i.canAccessOrgWorkspace)throw Error("You do not have permission to complete appointments.");let k=await (0,e.ensurePortalProfile)(h,i.userId),l=await p(h,b);q(l,{...i,profile:k},"staff");let{error:m}=await h.schema("portal").from("appointments").update({status:"completed",outcome_notes:c}).eq("id",b).eq("organization_id",l.organization_id);if(m)throw m;return await (0,g.logAuditEvent)(h,{actorProfileId:k.id,action:"appointment_completed",entityType:"appointment",entityRef:(0,g.buildEntityRef)({schema:"portal",table:"appointments",id:b}),meta:{outcome_notes:c}}),await r(),{success:!0}}catch(a){return console.error("completeAppointment error",a),{success:!1,error:"Unable to mark complete right now."}}}async function y(a){try{let b=j(a,"appointment_id"),c=j(a,"cancellation_reason");if(!b)throw Error("Missing appointment id.");let h=await (0,d.createSupabaseServerClient)(),i=await (0,f.loadPortalAccess)(h);if(!i||!i.canAccessStaffWorkspace&&!i.canAccessAdminWorkspace&&!i.canAccessOrgWorkspace)throw Error("You do not have permission to cancel appointments.");let k=await (0,e.ensurePortalProfile)(h,i.userId),l=await p(h,b);q(l,{...i,profile:k},"staff");let{error:m}=await h.schema("portal").from("appointments").update({status:"cancelled_by_staff",canceled_at:new Date().toISOString(),cancellation_reason:c??"Cancelled by staff"}).eq("id",b).eq("organization_id",l.organization_id);if(m)throw m;return await (0,g.logAuditEvent)(h,{actorProfileId:k.id,action:"appointment_cancelled_by_staff",entityType:"appointment",entityRef:(0,g.buildEntityRef)({schema:"portal",table:"appointments",id:b}),meta:{cancellation_reason:c}}),await r(),{success:!0}}catch(a){return console.error("cancelAppointmentAsStaff error",a),{success:!1,error:"Unable to cancel appointment right now."}}}(0,i.ensureServerEntryExports)([s,t,u,v,w,x,y]),(0,b.registerServerReference)(s,"600102d73d25a57cfcd2aaef97cf8064c97b47bd11",null),(0,b.registerServerReference)(t,"401d5343e20de90b5d636ec5b8f2a0b0243ce53393",null),(0,b.registerServerReference)(u,"40d7c2e75b5c56068b63736659e17edff613009ce9",null),(0,b.registerServerReference)(v,"402fe36c58fda2bce8ea18730c116e02a9cf0c14c2",null),(0,b.registerServerReference)(w,"40e69f9232cd1f161bb3e7569200e389fc802e83c0",null),(0,b.registerServerReference)(x,"405658c12f643d4810da278bca377ac2eaf4ae4451",null),(0,b.registerServerReference)(y,"40e59ea5660bafb4f74272183431b5cba15a5dc14a",null),a.s(["cancelAppointmentAsClient",()=>t,"cancelAppointmentAsStaff",()=>y,"completeAppointment",()=>x,"confirmAppointment",()=>v,"createOfflineAppointment",()=>w,"requestAppointmentAction",()=>s,"requestRescheduleAsClient",()=>u])}];

//# sourceMappingURL=_fb41848b._.js.map