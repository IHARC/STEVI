module.exports=[94686,31575,a=>{"use strict";var b=a.i(7997),c=a.i(37936);a.i(70396);var d=a.i(73727),e=a.i(9919),f=a.i(65108),g=a.i(83272),h=a.i(81296),i=a.i(35330),j=a.i(38904),k=a.i(43562),l=a.i(58774),m=a.i(46592),n=a.i(3412),o=a.i(18558),p=a.i(16349),q=a.i(63985),r=a.i(42145),s=a.i(67230);function t(a){return{status:"error",message:a}}async function u(a){let b=Number.parseInt(String(a.get("person_id")??""),10);if(!b||Number.isNaN(b))return t("Invalid person id.");let c=await (0,p.createSupabaseServerClient)(),d=await (0,f.loadPortalAccess)(c);if(!d||!d.canManageConsents)return t("You do not have permission to reset onboarding.");let e=new Date().toISOString(),g=c.schema("core"),h=c.schema("case_mgmt"),{error:i}=await g.from("people").update({data_sharing_consent:null,updated_at:e,updated_by:d.userId}).eq("id",b);if(i)return t("Unable to reset sharing preference.");let{error:j}=await h.from("client_intakes").insert({person_id:b,consent_confirmed:!1,privacy_acknowledged:!1,intake_date:e.slice(0,10),intake_worker:d.profile.id,general_notes:"Onboarding reset by admin; previous consent superseded."});return j?t("Sharing reset, but consent history could not be updated."):(await (0,q.logAuditEvent)(c,{actorProfileId:d.profile.id,action:"onboarding_reset",entityType:"people",entityRef:(0,q.buildEntityRef)({schema:"core",table:"people",id:b}),meta:{person_id:b,reset_by:d.profile.id}}),(0,o.revalidatePath)(`/admin/clients/${b}`),{status:"success",message:"Onboarding reset. Consents now require renewal."})}async function v(a){let b=Number.parseInt(String(a.get("person_id")??""),10);if(!b||Number.isNaN(b))return t("Invalid person id.");let c=await (0,p.createSupabaseServerClient)(),d=await (0,f.loadPortalAccess)(c);if(!d||!d.canManageConsents)return t("You do not have permission to resend onboarding links.");let e=c.schema("core"),{data:g,error:h}=await e.from("user_people").select("profile_id, user_id").eq("person_id",b).order("linked_at",{ascending:!1}).limit(1).maybeSingle();if(h||!g?.profile_id)return t("No linked account found to notify.");let i=await (0,r.getUserEmailForProfile)(c,g.profile_id);if(!i)return t("Linked user has no email on file.");let j="https://stevi.iharc.ca",k=j&&j.startsWith("http")?`${j}/onboarding`:"/onboarding";return await (0,s.queuePortalNotification)(c,{profileId:g.profile_id,email:i,subject:"Complete your STEVI onboarding",bodyText:`Please finish onboarding so we can share updates and documents. Open ${k} to continue.`,type:"onboarding_reminder",payload:{person_id:b,link:k}}),await (0,q.logAuditEvent)(c,{actorProfileId:d.profile.id,action:"onboarding_link_resent",entityType:"people",entityRef:(0,q.buildEntityRef)({schema:"core",table:"people",id:b}),meta:{person_id:b,target_profile_id:g.profile_id}}),(0,o.revalidatePath)(`/admin/clients/${b}`),{status:"success",message:"Reminder sent to the linked account."}}async function w(a){let b=Number.parseInt(String(a.get("person_id")??""),10);if(!b||Number.isNaN(b))return t("Invalid person id.");let c=await (0,p.createSupabaseServerClient)(),d=await (0,f.loadPortalAccess)(c);return d&&d.canManageConsents?(await (0,n.getOnboardingStatus)({personId:b},c),(0,o.revalidatePath)(`/admin/clients/${b}`),{status:"success",message:"Onboarding status refreshed."}):t("You do not have permission to refresh onboarding.")}(0,a.i(13095).ensureServerEntryExports)([u,v,w]),(0,c.registerServerReference)(u,"401e1fcfb3aec3ef162e23119158969822f508f234",null),(0,c.registerServerReference)(v,"4088647aff9be09d02bc40b5e4c6aaf647c1ed8dd5",null),(0,c.registerServerReference)(w,"402c0da09b175d223d56a3506b7ff24de338f3f9e7",null),a.s(["refreshOnboardingStatusAction",()=>w,"resendOnboardingLinkAction",()=>v,"resetOnboardingAction",()=>u],31575);var x=a.i(19637),y=a.i(10508);let z=async function(a){await u(a)};(0,c.registerServerReference)(z,"40346c8877bb34dd2b0514d0a467a67457a016d637",null);let A=async function(a){await v(a)};async function B({params:a}){let{personId:c}=await a,g=Number.parseInt(c,10);(!g||Number.isNaN(g))&&(0,d.notFound)();let j=await (0,e.createSupabaseRSCClient)(),k=await (0,f.loadPortalAccess)(j);k||(0,d.redirect)("/login?next=/admin/clients"),k.canManageConsents||(0,d.redirect)((0,m.resolveDefaultWorkspacePath)(k));let l=await C(j,g);l||(0,d.notFound)();let[o,p,q,r]=await Promise.all([(0,h.fetchPersonGrants)(j,g),D(j),(0,n.getOnboardingStatus)({personId:g},j),(0,y.getGrantScopes)(j)]),s=await E(j,l,q.profileId);return(0,b.jsxs)("div",{className:"page-shell page-stack",children:[(0,b.jsxs)("header",{className:"space-y-space-2xs",children:[(0,b.jsx)("p",{className:"text-label-sm font-semibold uppercase text-muted-foreground",children:"Client access"}),(0,b.jsxs)("h1",{className:"text-title-lg text-on-surface sm:text-headline-sm",children:[l.first_name??"Person"," ",l.last_name??""]}),(0,b.jsx)("p",{className:"max-w-3xl text-body-md text-muted-foreground sm:text-body-lg",children:"Manage consents and granular access grants. All actions are audited."})]}),(0,b.jsx)(I,{personId:l.id,onboardingStatus:q}),(0,b.jsx)(K,{events:s}),(0,b.jsxs)("div",{className:"grid gap-space-lg lg:grid-cols-[2fr,1fr]",children:[(0,b.jsxs)(i.Card,{children:[(0,b.jsxs)(i.CardHeader,{className:"space-y-space-2xs",children:[(0,b.jsx)(i.CardTitle,{className:"text-title-md",children:"Consent overrides"}),(0,b.jsx)(i.CardDescription,{children:"Adjust sharing and contact preferences with client approval."})]}),(0,b.jsx)(i.CardContent,{children:(0,b.jsx)(F,{person:l})})]}),(0,b.jsxs)(i.Card,{children:[(0,b.jsxs)(i.CardHeader,{className:"space-y-space-2xs",children:[(0,b.jsx)(i.CardTitle,{className:"text-title-md",children:"Access grants"}),(0,b.jsx)(i.CardDescription,{children:"Grant orgs or users scoped access; revoke when no longer needed."})]}),(0,b.jsxs)(i.CardContent,{className:"space-y-space-md",children:[(0,b.jsx)(G,{personId:l.id,organizations:p,scopes:r}),(0,b.jsx)(H,{grants:o})]})]})]})]})}async function C(a,b){let{data:c,error:d}=await a.schema("core").from("people").select("id, first_name, last_name, email, phone, data_sharing_consent, preferred_contact_method, privacy_restrictions, created_at, created_by, updated_at").eq("id",b).maybeSingle();if(d)throw d;return c}async function D(a){let{data:b,error:c}=await a.schema("core").from("organizations").select("id, name").order("name");if(c)throw c;return(b??[]).map(a=>({id:a.id,name:a.name}))}async function E(a,b,c){let d=a.schema("case_mgmt"),e=a.schema("core"),f=a.schema("portal"),[g,h,i]=await Promise.all([d.from("client_intakes").select("id, consent_confirmed, privacy_acknowledged, created_at, intake_worker").eq("person_id",b.id).order("created_at",{ascending:!1}).limit(10),e.from("user_people").select("profile_id, user_id, linked_at").eq("person_id",b.id).order("linked_at",{ascending:!1}).limit(5),c?f.from("registration_flows").select("id, status, flow_type, updated_at, created_at").eq("profile_id",c).order("updated_at",{ascending:!1}).limit(5):Promise.resolve({data:[],error:null})]);if(g.error)throw g.error;if(h.error)throw h.error;if("error"in i&&i.error)throw i.error;let j=[];for(let a of(b.created_at&&j.push({at:b.created_at,label:"Person record created",detail:b.created_by?`Created by ${b.created_by}`:void 0,source:"core.people"}),b.updated_at&&b.updated_at!==b.created_at&&j.push({at:b.updated_at,label:"Person record updated",detail:b.privacy_restrictions?"Privacy notes present":void 0,source:"core.people"}),g.data??[]))j.push({at:a.created_at,label:"Consent captured",detail:`Service: ${a.consent_confirmed?"accepted":"pending"} • Privacy: ${a.privacy_acknowledged?"acknowledged":"pending"}${a.intake_worker?` • Worker: ${a.intake_worker}`:""}`,source:"case_mgmt.client_intakes"});for(let a of h.data??[])a.linked_at&&j.push({at:a.linked_at,label:"Account linked",detail:`${a.profile_id?`Profile ${a.profile_id}`:"Profile unknown"}${a.user_id?` • User ${a.user_id}`:""}`,source:"core.user_people"});for(let a of i.data??[]){let b=a.updated_at??a.created_at;b&&j.push({at:b,label:"Registration updated",detail:`${a.flow_type??"client_onboarding"} • ${a.status??"in_progress"}`,source:"portal.registration_flows"})}return j.sort((a,b)=>Date.parse(b.at)-Date.parse(a.at))}function F({person:a}){return(0,b.jsxs)("form",{action:g.adminOverrideConsentAction,className:"space-y-space-sm",children:[(0,b.jsx)("input",{type:"hidden",name:"person_id",value:a.id}),(0,b.jsxs)("label",{className:"flex items-center gap-space-sm text-body-sm text-on-surface",children:[(0,b.jsx)("input",{type:"checkbox",name:"data_sharing",defaultChecked:!!a.data_sharing_consent,className:"h-4 w-4 rounded border-outline/60"}),(0,b.jsx)("span",{children:"Allow data sharing"})]}),(0,b.jsxs)("div",{className:"space-y-space-2xs",children:[(0,b.jsx)(k.Label,{className:"text-label-sm",children:"Preferred contact"}),(0,b.jsxs)("select",{name:"preferred_contact",defaultValue:a.preferred_contact_method??"email",className:"w-full rounded-md border border-outline/40 bg-surface px-space-sm py-space-2xs text-body-sm",children:[(0,b.jsx)("option",{value:"email",children:"Email"}),(0,b.jsx)("option",{value:"phone",children:"Phone"}),(0,b.jsx)("option",{value:"both",children:"Both"}),(0,b.jsx)("option",{value:"none",children:"None"})]})]}),(0,b.jsxs)("div",{className:"space-y-space-2xs",children:[(0,b.jsx)(k.Label,{htmlFor:"privacy_notes",className:"text-label-sm",children:"Privacy notes"}),(0,b.jsx)(l.Textarea,{id:"privacy_notes",name:"privacy_restrictions",defaultValue:a.privacy_restrictions??"",rows:3,placeholder:"Document verbal consent changes or safety constraints."})]}),(0,b.jsx)(j.Button,{type:"submit",className:"w-full",children:"Save override"})]})}function G({personId:a,organizations:c,scopes:d}){return(0,b.jsxs)("form",{action:g.adminCreateGrantAction,className:"space-y-space-sm",children:[(0,b.jsx)("input",{type:"hidden",name:"person_id",value:a}),(0,b.jsxs)("div",{className:"space-y-space-2xs",children:[(0,b.jsx)(k.Label,{className:"text-label-sm",htmlFor:"scope",children:"Scope"}),(0,b.jsx)("select",{id:"scope",name:"scope",className:"w-full rounded-md border border-outline/40 bg-surface px-space-sm py-space-2xs text-body-sm",defaultValue:"view",children:0===d.length?(0,b.jsx)("option",{value:"",children:"No scopes configured"}):d.map(a=>(0,b.jsx)("option",{value:a,children:a},a))})]}),(0,b.jsxs)("div",{className:"space-y-space-2xs",children:[(0,b.jsx)(k.Label,{className:"text-label-sm",children:"User ID (optional)"}),(0,b.jsx)("input",{name:"grantee_user_id",className:"w-full rounded-md border border-outline/40 bg-surface px-space-sm py-space-2xs text-body-sm",placeholder:"UUID of user"})]}),(0,b.jsxs)("div",{className:"space-y-space-2xs",children:[(0,b.jsx)(k.Label,{className:"text-label-sm",children:"Organization (optional)"}),(0,b.jsxs)("select",{name:"grantee_org_id",className:"w-full rounded-md border border-outline/40 bg-surface px-space-sm py-space-2xs text-body-sm",defaultValue:"",children:[(0,b.jsx)("option",{value:"",children:"—"}),c.map(a=>(0,b.jsx)("option",{value:a.id,children:a.name},a.id))]})]}),(0,b.jsx)(j.Button,{type:"submit",className:"w-full",children:"Grant access"})]})}function H({grants:a}){return 0===a.length?(0,b.jsx)("p",{className:"text-body-sm text-muted-foreground",children:"No active grants."}):(0,b.jsxs)("div",{className:"space-y-space-xs",children:[(0,b.jsx)("p",{className:"text-label-sm text-muted-foreground",children:"Active grants"}),(0,b.jsx)("ul",{className:"space-y-space-2xs",children:a.map(a=>(0,b.jsxs)("li",{className:"flex flex-wrap items-center justify-between gap-space-xs rounded-md border border-outline/30 bg-surface-container p-space-sm text-body-sm",children:[(0,b.jsxs)("div",{className:"space-y-space-3xs",children:[(0,b.jsx)("p",{className:"font-medium text-on-surface",children:a.scope}),(0,b.jsx)("p",{className:"text-muted-foreground",children:a.granteeUserId?`User ${a.granteeUserId}`:a.orgName?a.orgName:`Org ${a.granteeOrgId}`})]}),(0,b.jsxs)("form",{action:g.adminRevokeGrantAction,children:[(0,b.jsx)("input",{type:"hidden",name:"grant_id",value:a.id}),(0,b.jsx)(j.Button,{variant:"ghost",size:"sm",children:"Revoke"})]})]},a.id))})]})}function I({personId:a,onboardingStatus:c}){let d=c.lastUpdatedAt?new Date(c.lastUpdatedAt).toLocaleString():"Not recorded";return(0,b.jsxs)(i.Card,{children:[(0,b.jsxs)(i.CardHeader,{className:"space-y-space-2xs",children:[(0,b.jsx)(i.CardTitle,{className:"text-title-md",children:"Onboarding status"}),(0,b.jsx)(i.CardDescription,{children:"Audit the consent checklist and trigger resets or reminders."}),(0,b.jsxs)("div",{className:"flex flex-wrap items-center gap-space-sm",children:[(0,b.jsx)(x.Badge,{variant:"COMPLETED"===c.status?"default":"secondary",children:c.status.toLowerCase()}),(0,b.jsxs)("p",{className:"text-body-xs text-muted-foreground",children:["Last touch: ",d]})]})]}),(0,b.jsxs)(i.CardContent,{className:"space-y-space-sm",children:[(0,b.jsxs)("ul",{className:"space-y-space-2xs text-body-sm text-on-surface/80",children:[(0,b.jsx)(J,{done:c.hasPerson,children:"Active person record"}),(0,b.jsx)(J,{done:c.hasServiceAgreementConsent,children:"Service agreement captured"}),(0,b.jsx)(J,{done:c.hasPrivacyAcknowledgement,children:"Privacy acknowledgement captured"}),(0,b.jsxs)(J,{done:c.hasDataSharingPreference,children:["Sharing preference: ",c.hasDataSharingPreference?"set":"missing"]})]}),(0,b.jsxs)("div",{className:"flex flex-wrap gap-space-sm",children:[(0,b.jsxs)("form",{action:z,children:[(0,b.jsx)("input",{type:"hidden",name:"person_id",value:a}),(0,b.jsx)(j.Button,{type:"submit",variant:"secondary",children:"Reset onboarding"})]}),(0,b.jsxs)("form",{action:A,children:[(0,b.jsx)("input",{type:"hidden",name:"person_id",value:a}),(0,b.jsx)(j.Button,{type:"submit",variant:"outline",children:"Resend onboarding link"})]})]})]})]})}function J({done:a,children:c}){return(0,b.jsxs)("li",{className:"flex items-center gap-space-2xs",children:[(0,b.jsx)("span",{className:`inline-flex h-4 w-4 items-center justify-center rounded-full ${a?"bg-primary text-on-primary":"bg-outline/30 text-on-surface"}`,"aria-hidden":!0,children:a?"✓":""}),(0,b.jsx)("span",{className:a?"text-on-surface":"text-muted-foreground",children:c})]})}function K({events:a}){return(0,b.jsxs)(i.Card,{children:[(0,b.jsxs)(i.CardHeader,{className:"space-y-space-2xs",children:[(0,b.jsx)(i.CardTitle,{className:"text-title-md",children:"Onboarding history"}),(0,b.jsx)(i.CardDescription,{children:"Recent consent, sharing, and account-link events for this client."})]}),(0,b.jsx)(i.CardContent,{children:0===a.length?(0,b.jsx)("p",{className:"text-body-sm text-muted-foreground",children:"No onboarding activity recorded yet."}):(0,b.jsx)("ul",{className:"space-y-space-sm",children:a.map((a,c)=>(0,b.jsxs)("li",{className:"flex flex-wrap items-start justify-between gap-space-sm rounded-lg border border-outline/20 bg-surface-container-low p-space-sm",children:[(0,b.jsxs)("div",{className:"space-y-space-3xs",children:[(0,b.jsx)("p",{className:"text-body-md font-medium text-on-surface",children:a.label}),a.detail?(0,b.jsx)("p",{className:"text-body-sm text-muted-foreground",children:a.detail}):null,(0,b.jsx)("p",{className:"text-body-xs uppercase tracking-wide text-muted-foreground",children:a.source})]}),(0,b.jsx)("p",{className:"text-body-sm text-muted-foreground",children:new Date(a.at).toLocaleString()})]},`${a.source}-${a.at}-${c}`))})})]})}(0,c.registerServerReference)(A,"40dee2d6a43cef54e715707b07b71398c1288ee920",null),a.s(["$$RSC_SERVER_ACTION_0",0,z,"$$RSC_SERVER_ACTION_1",0,A,"default",()=>B,"dynamic",0,"force-dynamic"],94686)}];

//# sourceMappingURL=src_app_%28portal%29_admin_clients_%5BpersonId%5D_page_tsx_04d5a138._.js.map