module.exports=[63985,a=>{"use strict";let b="[redacted]",c=["password","token","secret","authorization","cookie","session","otp","code","sin","ssn","birth","dob","email","phone","contact","address"];function d(a){if(null===a||"object"!=typeof a)return!1;let b=Object.getPrototypeOf(a);return b===Object.prototype||null===b}let e=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,f=/^[0-9]+$/,g=/^[a-z0-9_]+$/i,h=/^[a-zA-Z0-9._:-]+$/;function i(a){if(null==a)return null;let b="number"==typeof a?String(a):a.trim?.()??a;return"string"!=typeof b||0===b.length?null:e.test(b)||f.test(b)?b:b.slice(0,128)}function j(a){let b=i(a);return b&&e.test(b)?b:null}function k(a){if(!a)return null;let{schema:b,table:c,id:d}=a;if(!g.test(b)||!g.test(c))return null;let e=i(d);return e&&h.test(e)?`${b.toLowerCase()}.${c.toLowerCase()}:${e}`:null}async function l(a,{actorProfileId:e=null,action:f,entityType:g,entityRef:h,entityId:i,meta:l}){let m=l&&d(l)?function a(e,f){let g={};return Object.entries(e).forEach(([e,h])=>{let i;if(i=e.toLowerCase(),c.some(a=>i.includes(a))){g[e]=b;return}let j=function c(e,f){if(void 0!==e){if(null===e)return null;if("string"==typeof e)return e.length>1024?`${e.slice(0,1024)}...`:e;if("number"==typeof e||"boolean"==typeof e)return e;if("bigint"==typeof e)return e.toString();if(e instanceof Date)return e.toISOString();if(e instanceof URL)return e.toString();if(e instanceof Error)return{name:e.name,message:e.message};if(Array.isArray(e))return e.map(a=>c(a,f)).filter(a=>void 0!==a);if(e instanceof Set)return Array.from(e).map(a=>c(a,f)).filter(a=>void 0!==a);if(e instanceof Map){let a={};return e.forEach((b,d)=>{let e=c(b,f);void 0!==e&&(a[String(d)]=e)}),a}return"object"==typeof e&&d(e)?f.has(e)?b:(f.add(e),a(e,f)):String(e)}}(h,f);void 0!==j&&(g[e]=j)}),g}(l,new WeakSet):{},n="string"==typeof h?h:k(h),o=j(i);!o&&n&&(o=j(n.split(":").pop()??null));let p=!n||"entity_ref"in m?m:{...m,entity_ref:n},q=j(e),{error:r}=await a.rpc("portal_log_audit_event",{p_action:f,p_entity_type:g,p_entity_id:o,p_meta:p,p_actor_profile_id:q});if(r)throw r}a.s(["buildEntityRef",()=>k,"logAuditEvent",()=>l],63985)},13095,(a,b,c)=>{"use strict";function d(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"ensureServerEntryExports",{enumerable:!0,get:function(){return d}})},6687,a=>{"use strict";function b(a){if("string"!=typeof a)return;let b=a.trim();if(!b)return;let c=b.startsWith("+"),d=b.replace(/\D+/g,"");if(d){if(c)return`+${d}`;if(10===d.length)return`+1${d}`;if(d.length>10)return`+${d}`}}function c(a){let c=b(a);if(!c)return"";let d=c.slice(-4),e=c.slice(0,Math.max(2,c.length-4)).replace(/\d/g,"*");return`${e}${d}`}a.s(["maskPhoneNumber",()=>c,"normalizePhoneNumber",()=>b])},66680,(a,b,c)=>{b.exports=a.x("node:crypto",()=>require("node:crypto"))},82465,a=>{"use strict";var b=a.i(66680);let c="0123456789";function d(a=8){if(a<=0)throw Error("Portal code length must be greater than zero");let e="";for(let d=0;d<a;d+=1){let a=b.default.randomInt(0,c.length);e+=c[a]}return e}function e(a){if(!a)return null;let b=a.replace(/[^0-9A-Za-z]/g,"").toUpperCase();return b.length<=4?b:8===b.length?`${b.slice(0,4)}-${b.slice(4)}`:9===b.length?`${b.slice(0,3)}-${b.slice(3,6)}-${b.slice(6)}`:b}function f(a){if("string"!=typeof a)return null;let b=a.trim();return 0===b.length?null:b}function g(a){if(!a)return null;let b=a.replace(/[^0-9A-Za-z]/g,"").toUpperCase();return b?6===b.length?`${b.slice(0,3)} ${b.slice(3)}`:b:null}a.s(["emptyToNull",()=>f,"formatPortalCode",()=>e,"generatePortalCode",()=>d,"normalizePostalCode",()=>g])},28725,a=>{"use strict";function b(a){if("string"!=typeof a)return;let b=a.trim();return b.length>0?b.toLowerCase():void 0}a.s(["normalizeEmail",()=>b])},39016,a=>{"use strict";function b(a){return a?.canAccessStaffWorkspace||a?.canManageConsents?"staff":a?.canAccessOrgWorkspace?"partner":"client"}function c(a){let b=[];if(a.safeCall||a.safeText||a.safeVoicemail){let c=[a.safeCall?"voice":null,a.safeText?"text":null,a.safeVoicemail?"voicemail":null].filter(Boolean);c.length&&b.push(`Safe contact: ${c.join(", ")}`)}if(a.contactWindow?.trim()&&b.push(`Contact window: ${a.contactWindow.trim()}`),a.postalCode?.trim()&&b.push(`Postal code: ${a.postalCode.trim()}`),a.dobYear&&a.dobMonth){let c=String(a.dobMonth).padStart(2,"0");b.push(`Birth month/year: ${c}/${a.dobYear}`)}return(a.extraNote?.trim()&&b.push(a.extraNote.trim()),0===b.length)?null:b.join(" â€¢ ")}a.s(["composeContactContext",()=>c,"resolveOnboardingActor",()=>b])},82722,a=>{"use strict";var b=a.i(86731),c=a.i(37936),d=a.i(16349),e=a.i(65108),f=a.i(63985),g=a.i(3412),h=a.i(39016),i=a.i(66799),j=a.i(6687),k=a.i(28725),l=a.i(82465),m=a.i(13095);let n={status:"idle"};function o(a){return{status:"error",message:a}}function p(a={}){return{status:"success",...a}}function q(a,b,c){if("string"!=typeof a)return null;let d=Number.parseInt(a,10);return Number.isNaN(d)||"number"==typeof b&&d<b||"number"==typeof c&&d>c?null:d}function r(a){return"on"===a||"true"===a}function s(a,b=160){if("string"!=typeof a)return null;let c=a.trim();return c?c.slice(0,b):null}async function t(a,{userId:b,profileId:c,chosenName:d,legalName:e,email:f,phone:g,safeCall:h,safeText:i,safeVoicemail:j,contactWindow:k,postalCode:l,dobMonth:m,dobYear:n,preferredContactMethod:o}){let p=a.schema("portal"),{data:q,error:r}=await p.from("registration_flows").select("id").eq("supabase_user_id",b).order("updated_at",{ascending:!1}).limit(1).maybeSingle();if(r)throw Error("Unable to save your onboarding details right now.");let s=new Date().toISOString(),t={chosen_name:d,legal_name:e,contact_email:f,contact_phone:g,contact_phone_safe_call:h,contact_phone_safe_text:i,contact_phone_safe_voicemail:j,contact_window:k,postal_code:l,date_of_birth_month:m,date_of_birth_year:n,supabase_user_id:b,profile_id:c,flow_type:"client_onboarding",status:"in_progress",updated_at:s,updated_by_user_id:b,metadata:{source:"onboarding_wizard",preferred_contact_method:o}};if(q?.id){let{error:a}=await p.from("registration_flows").update(t).eq("id",q.id);if(a)throw Error("Unable to update your onboarding details.")}else{let a={...t,chosen_name:d,flow_type:"client_onboarding",status:"in_progress",created_at:s,created_by_user_id:b},{error:c}=await p.from("registration_flows").insert(a);if(c)throw Error("Unable to save your onboarding details.")}}async function u(a,b){let{data:c,error:d}=await a.schema("core").from("people").select("id, status, data_sharing_consent").eq("id",b).maybeSingle();if(d)throw Error("Unable to load that client record right now.");return c??null}async function v(a,b,c){let d=a.schema("portal"),e=[b?`supabase_user_id.eq.${b}`:null,c?`profile_id.eq.${c}`:null].filter(Boolean);if(0===e.length)return null;let f=d.from("registration_flows").select("contact_window, postal_code, date_of_birth_month, date_of_birth_year, contact_phone_safe_call, contact_phone_safe_text, contact_phone_safe_voicemail").order("updated_at",{ascending:!1}).limit(1);if(1===e.length){let[a]=e,[b,c]=a.split(".eq.");b&&c&&(f=f.eq(b,c))}else f=f.or(e.join(","));let{data:g,error:h}=await f.maybeSingle();return h?null:g}async function w(a,b){let c=await (0,d.createSupabaseServerClient)(),m=await (0,e.loadPortalAccess)(c);if(!m)return o("Sign in to continue onboarding.");let n=(0,h.resolveOnboardingActor)(m),v=q(b.get("person_id")),w=s(b.get("chosen_name"))??"",x=s(b.get("legal_name")),y=s(b.get("pronouns")),z=s(b.get("preferred_contact_method"))??"email",A=s(b.get("contact_window"),120),B=(0,l.normalizePostalCode)(s(b.get("postal_code"))),C=q(b.get("dob_month"),1,12),D=q(b.get("dob_year"),1900,new Date().getFullYear()),E=r(b.get("safe_call")),F=r(b.get("safe_text")),G=r(b.get("safe_voicemail")),H=(0,k.normalizeEmail)(b.get("contact_email"))??null,I=(0,j.normalizePhoneNumber)(b.get("contact_phone"))??null,J=(0,h.composeContactContext)({contactWindow:A,postalCode:B,dobMonth:C,dobYear:D,safeCall:E,safeText:F,safeVoicemail:G});if(!w||w.length<2)return o("Share the name you want staff to use.");if(!H&&!I)return o("Add at least one way to contact you.");let K=v??null,L=!1;if(!K){let a=await (0,i.findPersonForUser)(c,m.userId);K=a?.id??null}let M=null;if(K&&(M=await u(c,K),M?.status==="inactive"))return o("This client record is inactive. Ask an admin to reactivate it before onboarding.");if(M){if("partner"===n&&!0!==M.data_sharing_consent)return o("Partner assistance is allowed only when the client has opted to share with partners.");let a=c.schema("core"),{error:b}=await a.from("people").update({first_name:w,last_name:x,email:H,phone:I,preferred_pronouns:y,preferred_contact_method:z,privacy_restrictions:J,updated_by:m.userId,updated_at:new Date().toISOString()}).eq("id",M.id);if(b)return o("Unable to save your details right now.")}else{if("client"===n||"partner"===n)return o("A client record is required. Please contact IHARC staff to start onboarding.");let a=c.schema("core"),{data:b,error:d}=await a.from("people").insert({first_name:w,last_name:x,email:H,phone:I,preferred_pronouns:y,preferred_contact_method:z,privacy_restrictions:J,status:"active",created_by:m.userId,updated_by:m.userId}).select("id, status, data_sharing_consent").single();if(d)return o("Unable to create the client record. Check your access or try again.");K=(M=b).id,L=!0}try{await t(c,{userId:m.userId,profileId:m.profile.id,chosenName:w,legalName:x,email:H,phone:I,safeCall:E,safeText:F,safeVoicemail:G,contactWindow:A,postalCode:B,dobMonth:C,dobYear:D,preferredContactMethod:z})}catch(a){console.warn("Failed to upsert registration draft",a)}return await (0,f.logAuditEvent)(c,{actorProfileId:m.profile.id,action:"onboarding_basic_info_saved",entityType:"people",entityRef:(0,f.buildEntityRef)({schema:"core",table:"people",id:K}),meta:{person_id:K,actor_role:n,created:L,preferred_contact_method:z}}),p({nextStatus:await (0,g.getOnboardingStatus)({userId:m.userId,personId:K},c),personId:K,profileId:m.profile.id})}async function x(a,b){let c=await (0,d.createSupabaseServerClient)(),i=await (0,e.loadPortalAccess)(c);if(!i)return o("Sign in to record consents.");if("partner"===(0,h.resolveOnboardingActor)(i))return o("Partners can review onboarding but cannot capture consents. Ask the client or IHARC staff to proceed.");let j=q(b.get("person_id")),k=r(b.get("consent_service_agreement")),l=r(b.get("consent_privacy"));if(!j)return o("A client record is required before capturing consent.");if(!k||!l)return o("Confirm the service agreement and privacy notice to continue.");let m=await u(c,j);if(!m||"inactive"===m.status)return o("That client record is inactive or missing.");let n=c.schema("case_mgmt"),s=new Date,t=await v(c,i.userId,i.profile.id),w=(0,h.composeContactContext)({contactWindow:t?.contact_window??null,postalCode:t?.postal_code??null,dobMonth:t?.date_of_birth_month??null,dobYear:t?.date_of_birth_year??null,safeCall:t?.contact_phone_safe_call??!1,safeText:t?.contact_phone_safe_text??!1,safeVoicemail:t?.contact_phone_safe_voicemail??!1}),{data:x,error:y}=await n.from("client_intakes").insert({person_id:j,consent_confirmed:k,privacy_acknowledged:l,intake_date:s.toISOString().slice(0,10),intake_worker:i.profile.id,general_notes:w}).select("id").single();return y||!x?o("Could not record consent right now."):(await (0,f.logAuditEvent)(c,{actorProfileId:i.profile.id,action:"onboarding_consents_recorded",entityType:"case_mgmt.client_intakes",entityRef:(0,f.buildEntityRef)({schema:"case_mgmt",table:"client_intakes",id:x.id}),meta:{person_id:j,consent_confirmed:k,privacy_acknowledged:l}}),p({nextStatus:await (0,g.getOnboardingStatus)({userId:i.userId,personId:j},c),personId:j,profileId:i.profile.id}))}async function y(a,b){let c=await (0,d.createSupabaseServerClient)(),i=await (0,e.loadPortalAccess)(c);if(!i)return o("Sign in to update sharing preferences.");let j=(0,h.resolveOnboardingActor)(i);if("partner"===j)return o("Only the client or IHARC staff can change data sharing preferences.");let k=q(b.get("person_id")),l="partners"===(s(b.get("data_sharing"))??"iharc_only");if(!k)return o("A client record is required before setting sharing preferences.");let m=await u(c,k);if(!m||"inactive"===m.status)return o("That client record is inactive or missing.");let n=c.schema("core"),{error:r}=await n.from("people").update({data_sharing_consent:l,updated_at:new Date().toISOString(),updated_by:i.userId}).eq("id",k);return r?o("Unable to save the sharing choice right now."):(await (0,f.logAuditEvent)(c,{actorProfileId:i.profile.id,action:"onboarding_sharing_saved",entityType:"people",entityRef:(0,f.buildEntityRef)({schema:"core",table:"people",id:k}),meta:{person_id:k,data_sharing_consent:l,actor_role:j}}),p({nextStatus:await (0,g.getOnboardingStatus)({userId:i.userId,personId:k},c),personId:k,profileId:i.profile.id}))}async function z(a,b){let c=await (0,d.createSupabaseServerClient)(),i=await (0,e.loadPortalAccess)(c);if(!i)return o("Sign in to link your account.");if("client"!==(0,h.resolveOnboardingActor)(i))return o("Only the client can link their portal account to this record.");let j=q(b.get("person_id"));if(!j)return o("A client record is required before linking.");let k=await u(c,j);if(!k||"inactive"===k.status)return o("That client record is inactive or missing.");let l=c.schema("core"),{error:m}=await l.from("user_people").upsert({user_id:i.userId,profile_id:i.profile.id,person_id:j,linked_at:new Date().toISOString()});return m?o("Unable to link your account right now."):(await (0,f.logAuditEvent)(c,{actorProfileId:i.profile.id,action:"onboarding_account_linked",entityType:"user_people",entityRef:(0,f.buildEntityRef)({schema:"core",table:"user_people",id:j}),meta:{person_id:j,user_id:i.userId}}),p({nextStatus:await (0,g.getOnboardingStatus)({userId:i.userId,personId:j},c),personId:j,profileId:i.profile.id}))}(0,m.ensureServerEntryExports)([w,x,y,z,n]),(0,c.registerServerReference)(w,"6028260131f33144f32d3e08a5fb8607c2c113a90d",null),(0,c.registerServerReference)(x,"6002a832463af9c9a310084eec0c41e03afe6fb8cc",null),(0,c.registerServerReference)(y,"602674c5deb77e864deb7b651907c8b48140d7f1b6",null),(0,c.registerServerReference)(z,"606b76070236bace9df3bb5afac565ee5a71b4e16f",null),(0,c.registerServerReference)(n,"7fdfda462d5dbf3f64ed9d67fd12bebaacd0576a6f",null),a.s([],54622),a.i(54622),a.s(["00b7ee4fee263fec1fe8acb860989f6ddb47485e3a",()=>b.$$RSC_SERVER_ACTION_0,"6002a832463af9c9a310084eec0c41e03afe6fb8cc",()=>x,"602674c5deb77e864deb7b651907c8b48140d7f1b6",()=>y,"6028260131f33144f32d3e08a5fb8607c2c113a90d",()=>w,"606b76070236bace9df3bb5afac565ee5a71b4e16f",()=>z,"7fdfda462d5dbf3f64ed9d67fd12bebaacd0576a6f",()=>n],82722)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__66f80fb5._.js.map