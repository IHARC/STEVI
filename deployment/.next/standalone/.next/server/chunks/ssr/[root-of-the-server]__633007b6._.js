module.exports=[42145,3071,a=>{"use strict";let b="Member of the public";function c(a){return!!(a&&"object"==typeof a&&"message"in a&&"string"==typeof a.message)}function d(a,b){return"42501"===b.code?Error("You do not have permission to modify this profile. Contact a moderator for support."):Error("We could not load your profile right now. Please try again.")}async function e(a,e,f){let g=a.schema("portal"),h=async()=>{let{data:a,error:b}=await g.from("profiles").select("*").eq("user_id",e).maybeSingle();if(b){if(c(b)&&"406"===b.code)throw Error("Multiple profiles are linked to this account. Please contact an administrator to resolve the duplicate profile before continuing.");if(c(b))throw d("fetch your profile",b);throw b}return a??null},i=async b=>{try{await a.rpc("refresh_user_permissions",{user_uuid:b})}catch(a){}},j=async a=>{if(a.position_title||"community_member"!==a.affiliation_type)return a;let{data:c,error:d}=await g.from("profiles").update({position_title:b}).eq("id",a.id).select("*").maybeSingle();return d?a:c??a},k=await h();if(k)return k.user_id&&await i(k.user_id),j(k);let{count:l,error:m}=await g.from("profiles").select("id",{count:"exact",head:!0}).eq("user_id",e);if(m){if(c(m))throw d("check your profile",m);throw m}if((l??0)>0)throw Error("Multiple profiles are linked to this account. Please contact an administrator to resolve the duplicate profile before continuing.");let n=f?.affiliation_type??"community_member",o="community_member"===n,p=f?.affiliation_status??(o?"approved":"pending"),q=f?.affiliation_requested_at??("pending"===p?new Date().toISOString():null),r=f?.position_title??(o?b:null),s=f?.homelessness_experience??"none",t=f?.substance_use_experience??"none",u={user_id:e,display_name:f?.display_name??"Community Member",organization_id:f?.organization_id??null,rules_acknowledged_at:f?.rules_acknowledged_at??null,position_title:r,affiliation_type:n,affiliation_status:p,affiliation_requested_at:q,affiliation_reviewed_at:f?.affiliation_reviewed_at??null,affiliation_reviewed_by:f?.affiliation_reviewed_by??null,bio:f?.bio??null,avatar_url:f?.avatar_url??null,homelessness_experience:s,substance_use_experience:t,government_role_type:f?.government_role_type??null,requested_organization_name:f?.requested_organization_name??null,requested_government_name:f?.requested_government_name??null,requested_government_level:f?.requested_government_level??null,requested_government_role:f?.requested_government_role??null},{data:v,error:w}=await g.from("profiles").insert(u).select("*").single();if(w){if(c(w)&&"23505"===w.code){let a=await h();if(a)return j(a)}if(c(w)&&"406"===w.code)throw Error("Multiple profiles are linked to this account. Please contact an administrator to resolve the duplicate profile before continuing.");if(c(w))throw d("create your profile",w);throw w}return await i(e),j(v)}async function f(a,b){let{data:c,error:d}=await a.rpc("portal_get_user_email",{p_profile_id:b});if(d)throw d;return c??null}a.s(["NEW_ORGANIZATION_VALUE",0,"__new_org__","NO_ORGANIZATION_VALUE",0,"__none__","PUBLIC_MEMBER_ROLE_LABEL",0,b],3071),a.s(["ensurePortalProfile",()=>e,"getUserEmailForProfile",()=>f],42145)},37936,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"registerServerReference",{enumerable:!0,get:function(){return d.registerServerReference}});let d=a.r(11857)},16349,a=>{"use strict";var b=a.i(5246);a.i(42537);var c=a.i(5860),d=a.i(31507);async function e(){let{url:a,anonKey:e}=(0,d.getSupabaseEnv)(),f=await (0,b.cookies)();return(0,c.createServerClient)(a,e,{cookies:{getAll:()=>f.getAll(),setAll(a){a.forEach(({name:a,value:b,options:c})=>{try{f.set(a,b,{path:"/",sameSite:"lax",httpOnly:!0,secure:!0,...c})}catch(a){}})}}})}a.s(["createSupabaseServerClient",()=>e])},12573,a=>{"use strict";async function b({supabase:a,type:b,limit:c,cooldownMs:d}){let{data:e,error:f}=await a.rpc("portal_check_rate_limit",{p_event:b,p_limit:c,p_cooldown_ms:d??null});if(f)throw f;let[g]=e??[];return!g||g.allowed?{allowed:!0,retryInMs:0}:{allowed:!1,retryInMs:Math.max(g.retry_in_ms??0,0)||1e3}}a.s(["checkRateLimit",()=>b])},6687,a=>{"use strict";function b(a){if("string"!=typeof a)return;let b=a.trim();if(!b)return;let c=b.startsWith("+"),d=b.replace(/\D+/g,"");if(d){if(c)return`+${d}`;if(10===d.length)return`+1${d}`;if(d.length>10)return`+${d}`}}function c(a){let c=b(a);if(!c)return"";let d=c.slice(-4),e=c.slice(0,Math.max(2,c.length-4)).replace(/\d/g,"*");return`${e}${d}`}a.s(["maskPhoneNumber",()=>c,"normalizePhoneNumber",()=>b])},9307,a=>{"use strict";function b(a,c="/home"){if(!a)return c;let d=Array.isArray(a)?a[0]:a;return!d||!d.startsWith("/")||d.startsWith("//")?c:d}function c(a){if(!a)return null;let b=Array.isArray(a)?a[0]:a;return"google_auth_cancelled"===b||"google_auth_error"===b?b:null}a.s(["parseAuthErrorCode",()=>c,"resolveNextPath",()=>b])},66680,(a,b,c)=>{b.exports=a.x("node:crypto",()=>require("node:crypto"))},82465,a=>{"use strict";var b=a.i(66680);let c="0123456789";function d(a=8){if(a<=0)throw Error("Portal code length must be greater than zero");let e="";for(let d=0;d<a;d+=1){let a=b.default.randomInt(0,c.length);e+=c[a]}return e}function e(a){if(!a)return null;let b=a.replace(/[^0-9A-Za-z]/g,"").toUpperCase();return b.length<=4?b:8===b.length?`${b.slice(0,4)}-${b.slice(4)}`:9===b.length?`${b.slice(0,3)}-${b.slice(3,6)}-${b.slice(6)}`:b}function f(a){if("string"!=typeof a)return null;let b=a.trim();return 0===b.length?null:b}function g(a){if(!a)return null;let b=a.replace(/[^0-9A-Za-z]/g,"").toUpperCase();return b?6===b.length?`${b.slice(0,3)} ${b.slice(3)}`:b:null}a.s(["emptyToNull",()=>f,"formatPortalCode",()=>e,"generatePortalCode",()=>d,"normalizePostalCode",()=>g])},37199,a=>{"use strict";var b=a.i(7997),c=a.i(39138);let d={"form-sm":"max-w-form-sm","form-md":"max-w-form-md","form-lg":"max-w-form-lg",xl:"max-w-page",page:"max-w-page"};function e({children:a,eyebrow:e,title:f,description:g,actions:h,maxWidth:i="form-lg",align:j="start",spacing:k="lg"}){let l="center"===j?"max-w-2xl":"max-w-3xl",m=!!(e||f||g||h);return(0,b.jsx)("div",{className:"page-shell",children:(0,b.jsxs)("div",{className:(0,c.cn)("mx-auto flex w-full flex-col","md"===k?"gap-space-lg":"gap-space-xl",d[i]),children:[m?(0,b.jsxs)("header",{className:(0,c.cn)("flex w-full flex-col gap-space-xs","center"===j?"items-center text-center":"items-start text-left"),children:[e?(0,b.jsx)("p",{className:"text-label-sm font-medium uppercase text-muted-foreground",children:e}):null,f?(0,b.jsx)("h1",{className:(0,c.cn)("text-headline-lg text-on-surface sm:text-display-sm",l),children:f}):null,g?"string"==typeof g?(0,b.jsx)("p",{className:(0,c.cn)("text-body-md text-muted-foreground sm:text-body-lg",l),children:g}):(0,b.jsx)("div",{className:(0,c.cn)("text-body-md text-muted-foreground sm:text-body-lg",l),children:g}):null,h?(0,b.jsx)("div",{className:"flex flex-wrap gap-space-sm pt-space-sm",children:h}):null]}):null,a]})})}a.s(["FormPageShell",()=>e])},50466,a=>{"use strict";var b=a.i(11857);let c=(0,b.registerClientReference)(function(){throw Error("Attempted to call CLIENT_INTAKE_INITIAL_STATE() from the server but CLIENT_INTAKE_INITIAL_STATE is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/app/register/_components/client-intake-form.tsx <module evaluation>","CLIENT_INTAKE_INITIAL_STATE"),d=(0,b.registerClientReference)(function(){throw Error("Attempted to call ClientIntakeForm() from the server but ClientIntakeForm is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/app/register/_components/client-intake-form.tsx <module evaluation>","ClientIntakeForm");a.s(["CLIENT_INTAKE_INITIAL_STATE",0,c,"ClientIntakeForm",0,d])},956,a=>{"use strict";var b=a.i(11857);let c=(0,b.registerClientReference)(function(){throw Error("Attempted to call CLIENT_INTAKE_INITIAL_STATE() from the server but CLIENT_INTAKE_INITIAL_STATE is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/app/register/_components/client-intake-form.tsx","CLIENT_INTAKE_INITIAL_STATE"),d=(0,b.registerClientReference)(function(){throw Error("Attempted to call ClientIntakeForm() from the server but ClientIntakeForm is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/app/register/_components/client-intake-form.tsx","ClientIntakeForm");a.s(["CLIENT_INTAKE_INITIAL_STATE",0,c,"ClientIntakeForm",0,d])},43572,a=>{"use strict";a.i(50466);var b=a.i(956);a.n(b)},34300,a=>{"use strict";var b=a.i(7997),c=a.i(37936);a.i(70396);var d=a.i(73727),e=a.i(43572),f=a.i(9307),g=a.i(82465),h=a.i(9919),i=a.i(16349),j=a.i(42145),k=a.i(6687),l=a.i(12573),m=a.i(37199);let n=async function(a,b){var c,e;let h,m="phone"===(h="string"==typeof(c=b.get("contact_choice"))?c.trim().toLowerCase():"")||"both"===h||"none"===h?h:"email",n=(0,g.emptyToNull)(b.get("contact_email")?.toLowerCase()??null),o=b.get("contact_phone"),r=o?(0,k.normalizePhoneNumber)(o)??null:null,s=(0,g.emptyToNull)(b.get("chosen_name"))??"",t=(0,g.emptyToNull)(b.get("legal_name")),u=(0,g.emptyToNull)(b.get("pronouns")),v=(0,g.emptyToNull)(b.get("contact_window")),w=(0,g.emptyToNull)(b.get("additional_context"));if(!s||s.length<2)return{status:"idle",error:"Share the name you would like us to use — at least two characters."};if(("email"===m||"both"===m)&&!n)return{status:"idle",error:"Enter a valid email or switch contact options."};if(("phone"===m||"both"===m)&&!r)return{status:"idle",error:"Include a phone number with area code (e.g. +16475551234) or choose a different contact option."};let x=q(m)?b.get("password")??"":null,y=q(m)?b.get("password_confirm")??"":null;if(q(m)){if(!x||x.length<12)return{status:"idle",error:"Create a password with at least 12 characters."};if(x!==y)return{status:"idle",error:"Confirm that both password entries match."}}let z="on"===b.get("consent_privacy"),A="on"===b.get("consent_terms"),B="none"!==m&&"on"===b.get("consent_contact");if(!z||!A)return{status:"idle",error:"We need your consent to our privacy notice and terms before continuing. You can review them any time."};if(q(m)&&!B)return{status:"idle",error:"Let us know if it is safe to contact you about your case, or choose the “no contact” option."};let C=p(b.get("dob_month")),D=p(b.get("dob_year")),E=(0,g.normalizePostalCode)((0,g.emptyToNull)(b.get("postal_code"))),F=(0,g.emptyToNull)(b.get("indigenous_identity")),G=(0,g.emptyToNull)(b.get("disability")),H=(0,g.emptyToNull)(b.get("gender_identity")),I=await (0,i.createSupabaseServerClient)(),J=await (0,l.checkRateLimit)({supabase:I,type:"registration_intake",limit:3,cooldownMs:3e5});if(!J.allowed){let a;return{status:"idle",error:(a=Math.max(1,Math.ceil(J.retryInMs/6e4)),`We’re receiving many requests. Please wait about ${a} minute${1===a?"":"s"} and try again.`)}}let K=I.schema("portal"),L=null,M=null,N=!1;if("none"!==m)try{if("phone"===m){let{data:a,error:b}=await I.auth.signUp({phone:r,password:x,options:{data:{display_name:s}}});if(b)return{status:"idle",error:b.message??"We could not create your account right now."};L=a.user?.id??null,N=!!a.session}else{let{data:a,error:b}=await I.auth.signUp({email:n,password:x,options:{emailRedirectTo:"https://stevi.iharc.ca/login",data:{display_name:s}}});if(b)return{status:"idle",error:b.message??"We could not create your account right now."};L=a.user?.id??null,N=!!a.session}}catch(a){if(a instanceof Error)return{status:"idle",error:a.message};return{status:"idle",error:"We could not create your account right now."}}if(N&&L)try{M=(await (0,j.ensurePortalProfile)(I,L,{display_name:s,affiliation_type:"community_member",position_title:"Client"})).id}catch(a){console.warn("Unable to ensure portal profile during intake",a)}let O={flow_type:"client_intake",status:"submitted",chosen_name:s,legal_name:t,pronouns:u,contact_email:n,contact_phone:r,contact_phone_safe_call:"on"===b.get("safe_call"),contact_phone_safe_text:"on"===b.get("safe_text"),contact_phone_safe_voicemail:"on"===b.get("safe_voicemail"),contact_window:v,date_of_birth_month:C,date_of_birth_year:D,postal_code:E,indigenous_identity:F,disability:G,gender_identity:H,consent_data_sharing:z,consent_contact:B,consent_terms:A,metadata:{additional_context:w,contact_window:v,contact_choice:m},supabase_user_id:L,profile_id:M},P=null,Q="none"===m?6:3;for(let a=0;a<Q;a+=1){let a=(0,g.generatePortalCode)(),b={...O,portal_code:a},{error:c}=await K.from("registration_flows").insert(b);if(!c){P=a;break}if("23505"!==c.code)return console.error("Unable to store registration intake",c),{status:"idle",error:"We could not save your intake right now. Try again in a few minutes or reach out to an outreach worker."}}if(!P)return{status:"idle",error:"We could not generate a portal code. Please try again or ask staff to assist."};if(N&&L){let a=b.get("next"),c=(0,f.resolveNextPath)("string"==typeof a?a:void 0);(0,d.redirect)(c)}return{status:"success",portalCode:(0,g.formatPortalCode)(P)??P,message:"none"===(e=m)?"Record this 8-digit code and bring it to IHARC staff when you are ready to finish setting up your account.":"phone"===e?"We sent a secure text with instructions to verify your account. Keep your code handy as a backup with staff.":"both"===e?"We emailed and texted verification instructions. Use whichever method is safest and keep your code handy.":"We emailed instructions to finish verifying your account. You can use this code as backup with staff.",contactEmail:n,contactPhone:r?(0,k.maskPhoneNumber)(r):null}};async function o({searchParams:a}){let c=a?await a:void 0,g=(0,f.resolveNextPath)(c?.next),i=await (0,h.createSupabaseRSCClient)(),{data:{user:j}}=await i.auth.getUser();return j&&(0,d.redirect)(g),(0,b.jsx)(m.FormPageShell,{maxWidth:"form-lg",children:(0,b.jsx)(e.ClientIntakeForm,{action:n,initialState:e.CLIENT_INTAKE_INITIAL_STATE,nextPath:g})})}function p(a){if("string"!=typeof a)return null;let b=a.trim();if(!b)return null;let c=Number.parseInt(b,10);return Number.isNaN(c)?null:c}function q(a){return"email"===a||"phone"===a||"both"===a}(0,c.registerServerReference)(n,"60732aba7f1eb24d42257fbf7baf8919ae18e3062e",null),a.s(["$$RSC_SERVER_ACTION_0",0,n,"default",()=>o,"dynamic",0,"force-dynamic"])},29732,a=>{"use strict";var b=a.i(34300);a.s([],1500),a.i(1500),a.s(["60732aba7f1eb24d42257fbf7baf8919ae18e3062e",()=>b.$$RSC_SERVER_ACTION_0],29732)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__633007b6._.js.map